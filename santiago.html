<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CityMesh ‚Äî Santiago de Chile</title>
<style>
:root {
  --bg:#060d1a;--surface:#0d1627;--surface2:#152035;--surface3:#1c2d45;
  --accent:#00c8ff;--accent2:#7c3aed;--accent3:#10b981;
  --warn:#f59e0b;--danger:#ef4444;--info:#3b82f6;
  --text:#e2e8f0;--muted:#64748b;--border:#1e293b;
  --cl-red:#d52b1e;--cl-blue:#003087;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;line-height:1.6;overflow-x:hidden;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}

/* NAV */
nav{position:sticky;top:0;z-index:1000;background:rgba(6,13,26,0.98);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 1.5rem;display:flex;align-items:center;justify-content:space-between;height:58px;gap:1rem;}
.logo-wrap{display:flex;align-items:center;gap:0.75rem;flex-shrink:0;}
.logo-flag{display:flex;flex-direction:column;width:22px;height:16px;border-radius:2px;overflow:hidden;}
.flag-top{flex:1;background:var(--cl-red);}
.flag-bot{flex:1;background:var(--cl-blue);}
.logo{font-size:1.2rem;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.logo-sub{font-size:0.65rem;color:var(--muted);display:block;-webkit-text-fill-color:var(--muted);}
.nav-pills{display:flex;gap:0.2rem;flex-wrap:nowrap;}
.pill{padding:0.3rem 0.85rem;border-radius:20px;font-size:0.75rem;cursor:pointer;border:none;background:transparent;color:var(--muted);transition:all 0.2s;font-weight:500;white-space:nowrap;}
.pill:hover{background:var(--surface2);color:var(--text);}
.pill.active{background:var(--accent);color:#000;font-weight:700;}
.nav-right{display:flex;align-items:center;gap:0.75rem;flex-shrink:0;}
.badge-live{background:rgba(239,68,68,0.12);color:var(--danger);border:1px solid rgba(239,68,68,0.3);padding:0.2rem 0.6rem;border-radius:10px;font-size:0.65rem;font-weight:700;animation:pulse-badge 2s infinite;}
@keyframes pulse-badge{0%,100%{opacity:1}50%{opacity:0.55}}
.nav-btn{padding:0.3rem 0.9rem;border-radius:8px;font-size:0.75rem;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--text);transition:all 0.2s;font-weight:500;}
.nav-btn:hover{border-color:var(--accent);color:var(--accent);}
.nav-btn.primary{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700;}
.nav-btn.primary:hover{background:#00aadd;color:#000;}

/* SECTIONS */
.section{display:none;min-height:calc(100vh - 58px);}
.section.active{display:block;}

/* HERO */
.hero{padding:3.5rem 2rem 2.5rem;text-align:center;background:radial-gradient(ellipse at 50% 0%,rgba(0,200,255,0.07) 0%,transparent 65%);position:relative;overflow:hidden;}
.hero-particles{position:absolute;inset:0;pointer-events:none;}
.particle{position:absolute;border-radius:50%;animation:float-p linear infinite;opacity:0;}
@keyframes float-p{0%{transform:translateY(100vh);opacity:0}10%{opacity:0.7}90%{opacity:0.2}100%{transform:translateY(-5vh) translateX(20px);opacity:0}}
.hero-tag{display:inline-flex;align-items:center;gap:0.5rem;border:1px solid rgba(0,200,255,0.35);color:var(--accent);font-size:0.7rem;padding:0.28rem 1rem;border-radius:20px;margin-bottom:1.25rem;letter-spacing:1.5px;font-weight:600;}
h1{font-size:clamp(1.8rem,4.5vw,3rem);font-weight:900;line-height:1.1;}
h1 em{font-style:normal;color:var(--accent);}
.hero-desc{color:var(--muted);max-width:540px;margin:0.85rem auto;font-size:0.95rem;}
.hero-cta{display:flex;gap:0.75rem;justify-content:center;margin-top:1.75rem;flex-wrap:wrap;}
.btn-primary{padding:0.65rem 1.75rem;border-radius:10px;background:linear-gradient(135deg,var(--accent),#0099bb);color:#000;font-weight:700;font-size:0.85rem;border:none;cursor:pointer;transition:all 0.2s;box-shadow:0 0 20px rgba(0,200,255,0.25);}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 0 30px rgba(0,200,255,0.45);}
.btn-secondary{padding:0.65rem 1.75rem;border-radius:10px;background:transparent;color:var(--text);font-weight:600;font-size:0.85rem;border:1px solid var(--border);cursor:pointer;transition:all 0.2s;}
.btn-secondary:hover{border-color:var(--accent);color:var(--accent);}
.hero-stats{display:flex;justify-content:center;gap:2.5rem;margin-top:2.5rem;flex-wrap:wrap;}
.stat{text-align:center;}
.stat-num{font-size:1.8rem;font-weight:800;color:var(--accent);}
.stat-label{font-size:0.7rem;color:var(--muted);}

/* COMUNE CHIPS */
.comune-strip{display:flex;gap:0.4rem;justify-content:center;flex-wrap:wrap;padding:0.75rem 2rem;background:var(--surface);border-bottom:1px solid var(--border);}
.comune-chip{padding:0.22rem 0.7rem;border-radius:12px;font-size:0.68rem;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--muted);transition:all 0.2s;white-space:nowrap;}
.comune-chip:hover,.comune-chip.active{background:rgba(0,200,255,0.1);border-color:var(--accent);color:var(--accent);}

/* CONTAINER */
.container{max-width:1400px;margin:0 auto;padding:0 1.5rem;}

/* MAP */
.map-section{padding:1.5rem;background:var(--surface);border-top:1px solid var(--border);border-bottom:1px solid var(--border);}
.map-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.6rem;}
.map-title-wrap{display:flex;align-items:center;gap:0.75rem;}
.map-title{font-size:0.95rem;font-weight:700;}
.map-controls{display:flex;gap:0.4rem;flex-wrap:wrap;}
.map-btn{padding:0.27rem 0.75rem;border-radius:8px;font-size:0.72rem;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--muted);transition:all 0.2s;}
.map-btn:hover,.map-btn.on{background:rgba(0,200,255,0.1);border-color:var(--accent);color:var(--accent);}
.map-container{position:relative;background:#07101f;border:1px solid var(--border);border-radius:14px;overflow:hidden;height:460px;cursor:crosshair;}
.map-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(0,200,255,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,200,255,0.025) 1px,transparent 1px);background-size:38px 38px;}

/* Santiago streets + blocks */
.st{position:absolute;background:rgba(18,28,45,0.92);}
.st-h{height:16px;left:0;right:0;border-top:1px solid rgba(80,100,130,0.18);border-bottom:1px solid rgba(80,100,130,0.18);}
.st-v{width:16px;top:0;bottom:0;border-left:1px solid rgba(80,100,130,0.18);border-right:1px solid rgba(80,100,130,0.18);}
.blk{position:absolute;background:rgba(12,20,35,0.55);border-radius:3px;}

/* Rio Mapocho */
.mapocho{position:absolute;background:rgba(0,60,120,0.3);border-top:2px solid rgba(0,120,200,0.4);border-bottom:1px solid rgba(0,80,160,0.3);}

/* Cerro San Cristobal */
.cerro{position:absolute;background:rgba(20,50,20,0.4);border:1px solid rgba(40,80,40,0.3);border-radius:50% 50% 0 0;}

/* nodes */
.mn{position:absolute;border-radius:50%;cursor:pointer;transform:translate(-50%,-50%);transition:transform 0.15s,box-shadow 0.15s;z-index:10;}
.mn:hover{transform:translate(-50%,-50%) scale(1.9);}
.mn::after{content:'';position:absolute;inset:-4px;border-radius:50%;border:2px solid currentColor;opacity:0;animation:ring-a 2.5s ease-out infinite;}
@keyframes ring-a{0%{transform:scale(0.8);opacity:0.6}100%{transform:scale(3);opacity:0}}
.n-ok{background:var(--accent3);color:var(--accent3);box-shadow:0 0 7px rgba(16,185,129,0.5);}
.n-warn{background:var(--warn);color:var(--warn);box-shadow:0 0 7px rgba(245,158,11,0.5);}
.n-alert{background:var(--danger);color:var(--danger);box-shadow:0 0 9px rgba(239,68,68,0.6);}
.n-offline{background:#2d3748;color:#2d3748;}
.n-offline::after{display:none;}
.n-gateway{background:var(--accent);color:var(--accent);box-shadow:0 0 12px rgba(0,200,255,0.6);width:16px!important;height:16px!important;}
.n-gateway::before{content:'‚¨°';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:10px;color:#000;}

svg.gossip-svg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:5;}
.gl{stroke:rgba(0,200,255,0.1);stroke-width:1;stroke-dasharray:5 5;animation:dash-a 4s linear infinite;}
.gl-active{stroke:rgba(0,200,255,0.5);stroke-width:1.5;animation:dash-a 1.8s linear infinite;}
.gl-warn{stroke:rgba(245,158,11,0.4);stroke-width:1.5;animation:dash-a 2.5s linear infinite;}
.gl-danger{stroke:rgba(239,68,68,0.45);stroke-width:2;animation:dash-a 1.5s linear infinite;}
@keyframes dash-a{to{stroke-dashoffset:-20}}

/* Packet animation */
.pkt{position:absolute;width:5px;height:5px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent);pointer-events:none;z-index:20;}

.map-legend{position:absolute;bottom:1rem;left:1rem;background:rgba(6,13,26,0.94);border:1px solid var(--border);border-radius:10px;padding:0.7rem;z-index:50;}
.li{display:flex;align-items:center;gap:0.45rem;font-size:0.65rem;color:var(--muted);margin-bottom:0.28rem;}
.li:last-child{margin-bottom:0;}
.ld{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.ld.square{border-radius:2px;}
.map-counter-badge{position:absolute;top:1rem;left:50%;transform:translateX(-50%);background:rgba(6,13,26,0.92);border:1px solid var(--border);border-radius:20px;padding:0.28rem 1rem;font-size:0.72rem;color:var(--muted);z-index:50;pointer-events:none;white-space:nowrap;}

/* Node panel */
.node-panel{position:absolute;top:1rem;right:1rem;background:rgba(6,13,26,0.97);border:1px solid var(--accent);border-radius:14px;padding:1.1rem;width:220px;z-index:100;transition:all 0.25s;}
.node-panel.hidden{opacity:0;pointer-events:none;transform:translateX(22px);}
.np-close{position:absolute;top:0.5rem;right:0.75rem;background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.9rem;}
.np-close:hover{color:var(--text);}
.np-hd{font-size:0.7rem;font-weight:700;margin-bottom:0.7rem;}
.np-r{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-bottom:0.28rem;}
.np-v{color:var(--text);font-weight:600;}
.np-ai{margin-top:0.7rem;padding:0.45rem;border-radius:8px;font-size:0.67rem;line-height:1.4;}
.np-actions{display:flex;gap:0.4rem;margin-top:0.7rem;}
.np-btn-sm{flex:1;padding:0.32rem;border-radius:7px;font-size:0.68rem;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--muted);transition:all 0.2s;}
.np-btn-sm:hover{border-color:var(--accent);color:var(--accent);}
.np-btn-sm.danger{border-color:rgba(239,68,68,0.4);color:var(--danger);}
.np-btn-sm.danger:hover{background:rgba(239,68,68,0.1);}

/* Earthquake indicator */
.seismic-bar{position:absolute;bottom:1rem;right:1rem;background:rgba(6,13,26,0.94);border:1px solid var(--border);border-radius:10px;padding:0.6rem 0.8rem;z-index:50;min-width:140px;}
.seismic-title{font-size:0.62rem;color:var(--muted);margin-bottom:0.4rem;font-weight:600;}
.seismic-track{height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:0.25rem;}
.seismic-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent3),var(--warn),var(--danger));transition:width 0.5s;}
.seismic-val{font-size:0.62rem;color:var(--muted);}

/* DASHBOARD */
.dashboard{padding:1.5rem;}
.sec-hd{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.75rem;padding:0.5rem 0 1.25rem;}
.sec-title{font-size:0.95rem;font-weight:700;}
.sec-sub{font-size:0.78rem;color:var(--muted);}
.dash-grid{display:grid;gap:1.1rem;margin-bottom:1.1rem;}
.g4{grid-template-columns:repeat(4,1fr);}
.g3{grid-template-columns:repeat(3,1fr);}
.g2{grid-template-columns:repeat(2,1fr);}
.g1{grid-template-columns:1fr;}
@media(max-width:1100px){.g4{grid-template-columns:repeat(2,1fr);}.g3{grid-template-columns:repeat(2,1fr);}}
@media(max-width:640px){.g4,.g3,.g2{grid-template-columns:1fr;}}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1.1rem;transition:border-color 0.2s;}
.panel:hover{border-color:rgba(0,200,255,0.18);}
.panel-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.9rem;}
.pt{font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600;}
.pa{font-size:0.68rem;color:var(--accent);cursor:pointer;background:none;border:none;}
.pa:hover{text-decoration:underline;}
.metric{font-size:2rem;font-weight:800;}
.msub{font-size:0.75rem;color:var(--muted);margin-top:0.2rem;}
.tu{color:var(--accent3);}
.td{color:var(--danger);}
canvas.spark{width:100%;height:46px;margin-top:0.65rem;}

/* Progress bars */
.pb-wrap{margin-bottom:0.68rem;}
.pb-hd{display:flex;justify-content:space-between;font-size:0.72rem;margin-bottom:0.28rem;}
.pb-track{height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.pb-fill{height:100%;border-radius:3px;transition:width 1.3s cubic-bezier(.4,0,.2,1);}
.f-ok{background:linear-gradient(90deg,var(--accent3),#34d399);}
.f-warn{background:linear-gradient(90deg,var(--warn),#fbbf24);}
.f-crit{background:linear-gradient(90deg,var(--danger),#f87171);}
.f-blue{background:linear-gradient(90deg,var(--accent),#38bdf8);}
.f-purple{background:linear-gradient(90deg,var(--accent2),#a78bfa);}
.f-info{background:linear-gradient(90deg,var(--info),#60a5fa);}

/* Alert feed */
.af-item{display:flex;gap:0.65rem;padding:0.65rem;border-radius:9px;background:var(--surface2);margin-bottom:0.45rem;border-left:3px solid transparent;cursor:pointer;transition:all 0.2s;align-items:flex-start;}
.af-item:hover{background:var(--surface3);}
.af-item.crit{border-left-color:var(--danger);}
.af-item.warn{border-left-color:var(--warn);}
.af-item.info{border-left-color:var(--info);}
.af-item.ok{border-left-color:var(--accent3);}
.af-icon{font-size:1rem;flex-shrink:0;}
.af-body{flex:1;min-width:0;}
.af-node{color:var(--accent);font-weight:700;font-size:0.67rem;}
.af-text{font-size:0.73rem;line-height:1.35;margin-top:0.1rem;}
.af-time{color:var(--muted);font-size:0.65rem;margin-top:0.1rem;}
.af-badge{margin-left:auto;padding:0.12rem 0.38rem;border-radius:6px;font-size:0.62rem;font-weight:700;white-space:nowrap;height:fit-content;flex-shrink:0;}
.b-crit{background:rgba(239,68,68,0.14);color:var(--danger);}
.b-warn{background:rgba(245,158,11,0.14);color:var(--warn);}
.b-info{background:rgba(59,130,246,0.14);color:var(--info);}
.b-ok{background:rgba(16,185,129,0.12);color:var(--accent3);}

/* Seismic monitor dashboard */
.seismic-monitor{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1.1rem;}
.seis-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:0.6rem;margin-top:0.75rem;}
.seis-card{background:var(--surface2);border-radius:9px;padding:0.65rem;text-align:center;}
.seis-val{font-size:1.3rem;font-weight:800;}
.seis-lbl{font-size:0.62rem;color:var(--muted);}
.seis-zone{font-size:0.58rem;color:var(--muted);}

/* Air quality map */
.aqi-legend{display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.75rem;}
.aqi-item{display:flex;align-items:center;gap:0.3rem;font-size:0.65rem;color:var(--muted);}
.aqi-dot{width:8px;height:8px;border-radius:2px;}

/* AI section */
.ai-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(205px,1fr));gap:0.9rem;}
.ai-card{background:var(--surface);border:1px solid var(--border);border-radius:13px;padding:1.1rem;position:relative;overflow:hidden;cursor:pointer;transition:all 0.22s;}
.ai-card:hover{border-color:rgba(124,58,237,0.5);transform:translateY(-2px);box-shadow:0 8px 24px rgba(124,58,237,0.08);}
.ai-card.running{border-color:var(--accent2);}
.ai-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(124,58,237,0.04),transparent);pointer-events:none;}
.ai-icon{font-size:1.4rem;margin-bottom:0.45rem;}
.ai-name{font-weight:700;font-size:0.85rem;margin-bottom:0.22rem;}
.ai-algo{font-size:0.65rem;color:var(--accent2);margin-bottom:0.4rem;}
.ai-desc{font-size:0.7rem;color:var(--muted);margin-bottom:0.7rem;line-height:1.4;}
.ai-stat{display:flex;align-items:center;gap:0.4rem;font-size:0.68rem;}
.ai-dot{width:6px;height:6px;border-radius:50%;background:var(--accent3);flex-shrink:0;}
.ai-dot.pulse{animation:pulse-badge 1s infinite;}
.ai-acc-bar{height:3px;background:var(--border);border-radius:2px;margin-top:0.35rem;overflow:hidden;}
.ai-acc-fill{height:100%;background:var(--accent2);border-radius:2px;}
.ai-run-btn{width:100%;margin-top:0.65rem;padding:0.37rem;border-radius:7px;font-size:0.7rem;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--muted);transition:all 0.2s;}
.ai-run-btn:hover,.ai-run-btn.running{border-color:var(--accent2);color:var(--accent2);background:rgba(124,58,237,0.08);}

/* Protocol */
.proto-section{padding:1.5rem;}
.packet-viz{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:1.4rem;}
.byte-row{display:flex;gap:3px;overflow-x:auto;padding-bottom:0.5rem;}
.bc{flex-shrink:0;height:40px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:0.56rem;font-weight:700;text-align:center;cursor:pointer;transition:all 0.18s;position:relative;}
.bc:hover{transform:translateY(-4px);filter:brightness(1.35);}
.bc-id{background:rgba(0,200,255,0.1);color:var(--accent);border:1px solid rgba(0,200,255,0.25);}
.bc-ts{background:rgba(124,58,237,0.1);color:#a78bfa;border:1px solid rgba(124,58,237,0.25);}
.bc-type{background:rgba(16,185,129,0.1);color:var(--accent3);border:1px solid rgba(16,185,129,0.25);}
.bc-hop{background:rgba(245,158,11,0.1);color:var(--warn);border:1px solid rgba(245,158,11,0.25);}
.bc-flag{background:rgba(239,68,68,0.1);color:#fca5a5;border:1px solid rgba(239,68,68,0.25);}
.bc-pay{background:rgba(30,41,59,0.7);color:var(--muted);border:1px solid var(--border);}
.bc-crc{background:rgba(244,114,182,0.1);color:#f9a8d4;border:1px solid rgba(244,114,182,0.25);}
.bc-tip{position:absolute;bottom:110%;left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:0.4rem 0.65rem;font-size:0.65rem;color:var(--text);white-space:nowrap;pointer-events:none;z-index:200;opacity:0;transition:opacity 0.12s;}
.bc:hover .bc-tip{opacity:1;}
.stbl{width:100%;border-collapse:collapse;}
.stbl th{font-size:0.68rem;color:var(--muted);text-align:left;padding:0.5rem 0.7rem;border-bottom:1px solid var(--border);}
.stbl td{font-size:0.75rem;padding:0.48rem 0.7rem;border-bottom:1px solid rgba(30,41,59,0.45);}
.stbl tbody tr{transition:background 0.12s;cursor:pointer;}
.stbl tbody tr:hover{background:var(--surface2);}
.ctag{background:rgba(0,200,255,0.09);color:var(--accent);padding:0.09rem 0.38rem;border-radius:4px;font-family:monospace;font-size:0.72rem;}

/* Terminal */
.terminal{background:#020610;border:1px solid var(--border);border-radius:13px;overflow:hidden;}
.term-bar{background:#0a0f1a;padding:0.45rem 1rem;display:flex;align-items:center;gap:0.45rem;border-bottom:1px solid var(--border);}
.tdot{width:10px;height:10px;border-radius:50%;}
.term-title{font-size:0.7rem;color:var(--muted);margin-left:0.45rem;flex:1;}
.term-clear{font-size:0.68rem;color:var(--muted);background:none;border:none;cursor:pointer;}
.term-clear:hover{color:var(--text);}
.term-body{padding:1.1rem;font-family:'Courier New',monospace;font-size:0.8rem;line-height:1.9;min-height:180px;max-height:300px;overflow-y:auto;}
.tp{color:#4ade80;}
.tc{color:#e2e8f0;}
.tf{color:#93c5fd;}
.tok{color:#4ade80;}
.ti{color:var(--accent);}
.tw{color:var(--warn);}
.te{color:var(--danger);}
.tm{color:#3d5068;}
.term-input-row{display:flex;padding:0.45rem 1.1rem 0.9rem;gap:0.45rem;border-top:1px solid var(--border);}
.term-input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'Courier New',monospace;font-size:0.8rem;}
.term-input::placeholder{color:#2a3a50;}
.term-run{padding:0.3rem 0.9rem;border-radius:6px;background:rgba(0,200,255,0.09);color:var(--accent);border:1px solid rgba(0,200,255,0.28);cursor:pointer;font-size:0.75rem;font-weight:600;transition:all 0.2s;}
.term-run:hover{background:rgba(0,200,255,0.18);}

/* Roadmap */
.roadmap-section{padding:1.5rem;background:var(--surface);border-top:1px solid var(--border);}
.roadmap{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--border);border:1px solid var(--border);border-radius:13px;overflow:hidden;}
@media(max-width:800px){.roadmap{grid-template-columns:1fr 1fr;}}
.phase{background:var(--surface);padding:1.35rem;position:relative;transition:background 0.18s;cursor:pointer;}
.phase:hover,.phase.cur{background:var(--surface2);}
.phase.cur{background:rgba(0,200,255,0.03);}
.ph-badge{display:inline-block;font-size:0.6rem;padding:0.18rem 0.48rem;border-radius:9px;margin-bottom:0.45rem;}
.ph-num{font-size:0.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:2px;}
.ph-name{font-weight:800;font-size:0.95rem;margin:0.2rem 0;}
.ph-time{font-size:0.72rem;color:var(--accent);margin-bottom:0.85rem;}
.ph-task{font-size:0.72rem;color:var(--muted);margin-bottom:0.32rem;display:flex;gap:0.4rem;align-items:flex-start;}
.t-done{color:var(--accent3);flex-shrink:0;}
.t-pend{color:var(--border);flex-shrink:0;}
.bc-now{background:rgba(16,185,129,0.1);color:var(--accent3);border:1px solid rgba(16,185,129,0.25);}
.bc-next{background:rgba(245,158,11,0.07);color:var(--warn);border:1px solid rgba(245,158,11,0.2);}
.bc-fut{background:rgba(30,41,59,0.5);color:var(--muted);border:1px solid var(--border);}
.prog-bar{display:flex;height:5px;border-radius:3px;overflow:hidden;background:var(--border);margin-top:1.25rem;}
.pr-done{background:var(--accent3);}
.pr-active{background:var(--accent);animation:pulse-badge 2s infinite;}
.pr-pend{flex:1;background:var(--border);}

/* Toasts */
.toast-container{position:fixed;bottom:1.25rem;right:1.25rem;z-index:9999;display:flex;flex-direction:column;gap:0.45rem;}
.toast{background:var(--surface2);border:1px solid var(--border);border-radius:11px;padding:0.65rem 0.9rem;font-size:0.78rem;min-width:270px;max-width:340px;display:flex;align-items:flex-start;gap:0.65rem;box-shadow:0 8px 24px rgba(0,0,0,0.45);animation:toast-in 0.28s ease,toast-out 0.28s ease 4.7s forwards;border-left:3px solid var(--accent);}
.toast.tw{border-left-color:var(--warn);}
.toast.te{border-left-color:var(--danger);}
.toast.tok{border-left-color:var(--accent3);}
.toast-icon{font-size:0.95rem;flex-shrink:0;}
.toast-body{flex:1;}
.toast-title{font-weight:700;font-size:0.75rem;margin-bottom:0.12rem;}
.toast-msg{color:var(--muted);font-size:0.7rem;}
.toast-x{background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.85rem;padding:0;}
@keyframes toast-in{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes toast-out{from{opacity:1}to{opacity:0;transform:translateX(100%)}}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:2000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.22s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:1.75rem;max-width:520px;width:92%;transform:scale(0.95);transition:transform 0.22s;max-height:80vh;overflow-y:auto;}
.modal-overlay.open .modal{transform:scale(1);}
.modal-hd{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.25rem;}
.modal-title{font-size:1rem;font-weight:800;}
.modal-x{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;}
.modal-x:hover{color:var(--text);}
.modal-body{font-size:0.82rem;color:var(--muted);line-height:1.75;}
.modal-ft{display:flex;gap:0.65rem;justify-content:flex-end;margin-top:1.25rem;}

/* Tabs */
.tab-bar{display:flex;gap:0.3rem;border-bottom:1px solid var(--border);margin-bottom:1rem;}
.tab{padding:0.5rem 1rem;font-size:0.78rem;cursor:pointer;border:none;background:none;color:var(--muted);border-bottom:2px solid transparent;transition:all 0.2s;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);font-weight:600;}

/* Footer */
footer{padding:1.75rem;text-align:center;color:var(--muted);font-size:0.75rem;border-top:1px solid var(--border);}
footer strong{color:var(--accent);}
.flinks{display:flex;gap:1.25rem;justify-content:center;margin-top:0.65rem;flex-wrap:wrap;}
.fl{color:var(--muted);font-size:0.72rem;cursor:pointer;transition:color 0.2s;}
.fl:hover{color:var(--accent);}

/* Notification dot */
.notif-dot{display:inline-block;width:6px;height:6px;background:var(--danger);border-radius:50%;margin-left:4px;vertical-align:middle;animation:pulse-badge 1.5s infinite;}
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="logo-wrap">
    <div class="logo-flag"><div class="flag-top"></div><div class="flag-bot"></div></div>
    <div>
      <span class="logo">CityMesh</span>
      <span class="logo-sub">RFC-001 ¬∑ Santiago de Chile ¬∑ Red Piloto</span>
    </div>
  </div>
  <div class="nav-pills">
    <button class="pill active" onclick="nav('home')">Inicio</button>
    <button class="pill" onclick="nav('dashboard')">Dashboard</button>
    <button class="pill" onclick="nav('seismic')">S√≠smico<span class="notif-dot"></span></button>
    <button class="pill" onclick="nav('ai')">IA</button>
    <button class="pill" onclick="nav('protocol')">Protocolo</button>
    <button class="pill" onclick="nav('sdk')">SDK</button>
    <button class="pill" onclick="nav('roadmap')">Roadmap</button>
  </div>
  <div class="nav-right">
    <span class="badge-live">‚óè EN VIVO</span>
    <button class="nav-btn" onclick="openModal('alerts')">üîî Alertas <span id="alert-count" style="background:var(--danger);color:#fff;border-radius:9px;padding:0 5px;font-size:0.65rem;margin-left:2px">8</span></button>
    <button class="nav-btn primary" onclick="openModal('deploy')">+ Nodo</button>
  </div>
</nav>

<!-- TOASTS -->
<div class="toast-container" id="TC"></div>

<!-- MODAL -->
<div class="modal-overlay" id="MO">
  <div class="modal">
    <div class="modal-hd">
      <div class="modal-title" id="MT"></div>
      <button class="modal-x" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="MB"></div>
    <div class="modal-ft" id="MF"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-home" class="section active">
  <div class="hero">
    <div class="hero-particles" id="particles"></div>
    <div class="hero-tag">üá®üá± CITYMESH SANTIAGO ‚Äî RFC-001 OPEN SOURCE</div>
    <h1>El Sistema Nervioso<br>de las<em>Ciudades</em></h1>
    <p class="hero-desc">Protocolo abierto que convierte la infraestructura de la Regi√≥n Metropolitana en una red inteligente de sensores. Desde el Mapocho hasta la Cordillera.</p>
    <div class="hero-cta">
      <button class="btn-primary" onclick="nav('dashboard')">Ver Dashboard</button>
      <button class="btn-secondary" onclick="nav('seismic')">üåã Monitor S√≠smico</button>
      <button class="btn-secondary" onclick="openModal('about')">¬øQu√© es CityMesh?</button>
    </div>
    <div class="hero-stats">
      <div class="stat"><div class="stat-num" id="sn-nodes">412</div><div class="stat-label">Nodos Activos</div></div>
      <div class="stat"><div class="stat-num">32</div><div class="stat-label">Comunas</div></div>
      <div class="stat"><div class="stat-num">$1‚Äì5</div><div class="stat-label">USD por nodo</div></div>
      <div class="stat"><div class="stat-num">15 min</div><div class="stat-label">Despliegue</div></div>
      <div class="stat"><div class="stat-num">6.8M</div><div class="stat-label">Habitantes cubiertos</div></div>
    </div>
  </div>

  <!-- COMUNI STRIP -->
  <div class="comune-strip" id="comunaStrip"></div>

  <!-- MAP -->
  <div class="map-section">
    <div class="container">
      <div class="map-toolbar">
        <div class="map-title-wrap">
          <div class="map-title">üó∫ Red CityMesh ‚Äî Gran Santiago</div>
        </div>
        <div class="map-controls">
          <button class="map-btn on" onclick="flt('all',this)">Todos</button>
          <button class="map-btn" onclick="flt('ok',this)">‚úÖ OK</button>
          <button class="map-btn" onclick="flt('warn',this)">‚ö†Ô∏è Alerta</button>
          <button class="map-btn" onclick="flt('alert',this)">üö® Cr√≠tico</button>
          <button class="map-btn" onclick="flt('offline',this)">‚ö´ Offline</button>
          <button class="map-btn" onclick="toggleGossip()">üì° Gossip</button>
          <button class="map-btn" onclick="togglePackets()">üì¶ Paquetes</button>
          <button class="map-btn" onclick="addNode()">‚ûï Simular Nodo</button>
          <button class="map-btn" onclick="triggerEarthquake()">üåã Simular Sismo</button>
        </div>
      </div>
      <div class="map-container" id="MC">
        <div class="map-grid"></div>
        <!-- Santiago geography -->
        <div class="mapocho" style="top:22%;left:0;right:0;height:18px;"></div>
        <div class="cerro" style="top:0;right:5%;width:14%;height:30%;border-radius:40% 40% 0 0;"></div>
        <!-- Streets -->
        <div class="st st-h" style="top:38%"></div>
        <div class="st st-h" style="top:55%"></div>
        <div class="st st-h" style="top:70%"></div>
        <div class="st st-h" style="top:83%"></div>
        <div class="st st-v" style="left:18%"></div>
        <div class="st st-v" style="left:34%"></div>
        <div class="st st-v" style="left:52%"></div>
        <div class="st st-v" style="left:68%"></div>
        <div class="st st-v" style="left:82%"></div>
        <!-- Blocks -->
        <div class="blk" style="top:26%;left:3%;width:13%;height:10%"></div>
        <div class="blk" style="top:26%;left:20%;width:12%;height:10%"></div>
        <div class="blk" style="top:26%;left:36%;width:14%;height:10%"></div>
        <div class="blk" style="top:26%;left:54%;width:12%;height:10%"></div>
        <div class="blk" style="top:26%;left:70%;width:10%;height:10%"></div>
        <div class="blk" style="top:41%;left:3%;width:13%;height:12%"></div>
        <div class="blk" style="top:41%;left:20%;width:12%;height:12%"></div>
        <div class="blk" style="top:41%;left:36%;width:14%;height:12%"></div>
        <div class="blk" style="top:41%;left:54%;width:12%;height:12%"></div>
        <div class="blk" style="top:41%;left:70%;width:10%;height:12%"></div>
        <div class="blk" style="top:58%;left:3%;width:13%;height:10%"></div>
        <div class="blk" style="top:58%;left:20%;width:12%;height:10%"></div>
        <div class="blk" style="top:58%;left:36%;width:14%;height:10%"></div>
        <div class="blk" style="top:58%;left:54%;width:12%;height:10%"></div>
        <div class="blk" style="top:58%;left:70%;width:10%;height:10%"></div>
        <div class="blk" style="top:73%;left:3%;width:13%;height:8%"></div>
        <div class="blk" style="top:73%;left:20%;width:12%;height:8%"></div>
        <div class="blk" style="top:73%;left:36%;width:14%;height:8%"></div>
        <svg class="gossip-svg" id="GSvg" viewBox="0 0 900 460" preserveAspectRatio="none"></svg>
        <div class="map-legend">
          <div style="font-size:0.65rem;font-weight:700;color:var(--text);margin-bottom:0.38rem">Estado de Nodos</div>
          <div class="li"><div class="ld" style="background:var(--accent3)"></div><span id="l-ok">OK (378)</span></div>
          <div class="li"><div class="ld" style="background:var(--warn)"></div><span id="l-warn">Alerta (21)</span></div>
          <div class="li"><div class="ld" style="background:var(--danger)"></div><span id="l-alert">Cr√≠tico (8)</span></div>
          <div class="li"><div class="ld" style="background:#2d3748"></div><span id="l-off">Offline (5)</span></div>
          <div class="li" style="margin-top:0.3rem"><div class="ld" style="background:var(--accent);border-radius:2px"></div><span>Gateway LoRa</span></div>
          <div class="li"><div class="ld" style="background:rgba(0,60,120,0.6)"></div><span>R√≠o Mapocho</span></div>
          <div class="li"><div class="ld" style="background:rgba(20,50,20,0.6)"></div><span>Cerro San Crist√≥bal</span></div>
        </div>
        <div class="map-counter-badge" id="MCB">412 nodos ¬∑ 32 comunas</div>
        <div class="seismic-bar" id="seismicBar">
          <div class="seismic-title">üåã Actividad S√≠smica</div>
          <div class="seismic-track"><div class="seismic-fill" id="seismicFill" style="width:12%"></div></div>
          <div class="seismic-val" id="seismicVal">0.8 Richter ‚Äî Normal</div>
        </div>
        <div class="node-panel hidden" id="NP">
          <button class="np-close" onclick="closePanel()">‚úï</button>
          <div class="np-hd" id="NPH">NODO</div>
          <div id="NPC"></div>
          <div class="np-actions">
            <button class="np-btn-sm" onclick="showToast('info','üìä Hist√≥rico','Cargando datos del nodo...')">Hist√≥rico</button>
            <button class="np-btn-sm" onclick="showToast('info','‚öôÔ∏è Config','Abriendo configuraci√≥n...')">Config</button>
            <button class="np-btn-sm danger" onclick="showToast('warn','‚ö†Ô∏è Reinicio','Enviando se√±al de reinicio...')">Reiniciar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-dashboard" class="section">
  <div class="dashboard container">
    <div class="sec-hd">
      <div>
        <div class="sec-title">üìä Panel de Control ‚Äî Santiago de Chile</div>
        <div class="sec-sub">Regi√≥n Metropolitana ¬∑ Actualizado hace <span id="upd">3</span>s ¬∑ <span style="color:var(--accent3)">‚óè Sistema operativo</span></div>
      </div>
      <div style="display:flex;gap:0.4rem;flex-wrap:wrap">
        <button class="map-btn on" onclick="setTR('1h',this)">1H</button>
        <button class="map-btn" onclick="setTR('6h',this)">6H</button>
        <button class="map-btn" onclick="setTR('24h',this)">24H</button>
        <button class="map-btn" onclick="setTR('7d',this)">7D</button>
        <button class="map-btn" onclick="setTR('30d',this)">30D</button>
      </div>
    </div>

    <div class="dash-grid g4">
      <div class="panel">
        <div class="panel-hd"><div class="pt">Nodos Activos</div><button class="pa" onclick="nav('home')">Ver mapa ‚Üí</button></div>
        <div class="metric" style="color:var(--accent3)" id="d-nodes">412</div>
        <div class="msub">de 425 desplegados &nbsp;<span class="tu">‚Üë 96.9%</span></div>
        <canvas class="spark" id="ch-nodes"></canvas>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="pt">Mensajes / Hora</div><button class="pa" onclick="nav('protocol')">Ver protocolo ‚Üí</button></div>
        <div class="metric" id="d-msgs">84.7K</div>
        <div class="msub">paquetes procesados &nbsp;<span class="tu">‚Üë 18%</span></div>
        <canvas class="spark" id="ch-msgs"></canvas>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="pt">Alertas Activas</div><button class="pa" onclick="openModal('alerts')">Ver todas ‚Üí</button></div>
        <div class="metric" style="color:var(--danger)" id="d-alerts">8</div>
        <div class="msub">requieren atenci√≥n &nbsp;<span class="td">‚Üë 3 nuevas</span></div>
        <canvas class="spark" id="ch-alerts"></canvas>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="pt">IA ‚Äî Predicciones</div><button class="pa" onclick="nav('ai')">Ver IA ‚Üí</button></div>
        <div class="metric" style="color:var(--accent2)">34</div>
        <div class="msub">predicciones hoy &nbsp;<span class="tu">‚Üë 93% precisi√≥n</span></div>
        <canvas class="spark" id="ch-ai"></canvas>
      </div>
    </div>

    <div class="dash-grid g3">
      <div class="panel">
        <div class="panel-hd"><div class="pt">Lecturas por Sensor</div><button class="pa" onclick="refreshBars()">‚Üª Refresh</button></div>
        <div id="sBars"></div>
      </div>
      <div class="panel" style="grid-column:span 2">
        <div class="panel-hd"><div class="pt">Alertas Recientes</div><button class="pa" onclick="markRead()">Marcar le√≠das</button></div>
        <div id="aFeed"></div>
      </div>
    </div>

    <div class="dash-grid g2">
      <div class="panel">
        <div class="panel-hd"><div class="pt">Calidad del Aire por Comuna</div><button class="pa" onclick="showToast('info','üå¨ AQI','Cargando datos hist√≥ricos...')">Ver hist√≥rico</button></div>
        <div id="aqiPanel"></div>
        <div class="aqi-legend">
          <div class="aqi-item"><div class="aqi-dot" style="background:#10b981"></div>Bueno (&lt;25)</div>
          <div class="aqi-item"><div class="aqi-dot" style="background:#f59e0b"></div>Moderado (25-50)</div>
          <div class="aqi-item"><div class="aqi-dot" style="background:#ef4444"></div>Da√±ino (&gt;50)</div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="pt">Estad√≠sticas por Comuna</div><button class="pa" onclick="rotateComuna()">‚Üª Siguiente</button></div>
        <div id="comunaStats"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEISMIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-seismic" class="section">
  <div class="dashboard container">
    <div class="sec-hd">
      <div>
        <div class="sec-title">üåã Monitor S√≠smico ‚Äî Red CityMesh Santiago</div>
        <div class="sec-sub">Chile es el pa√≠s m√°s s√≠smico del mundo ¬∑ 412 aceler√≥metros activos en la RM</div>
      </div>
      <button class="map-btn" style="height:fit-content" onclick="triggerEarthquake()">üåã Simular Sismo</button>
    </div>

    <div class="dash-grid g4">
      <div class="panel" style="border-color:rgba(239,68,68,0.2)">
        <div class="panel-hd"><div class="pt">√öltimo Evento</div></div>
        <div class="metric" id="last-mag" style="color:var(--warn)">3.2</div>
        <div class="msub">Richter ¬∑ <span id="last-loc">Pudahuel</span></div>
        <div style="font-size:0.7rem;color:var(--muted);margin-top:0.5rem" id="last-time">hace 4 horas</div>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="pt">Nodos Aceler√≥metro</div></div>
        <div class="metric" style="color:var(--accent3)">412</div>
        <div class="msub">activos en la RM &nbsp;<span class="tu">100% operativos</span></div>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="pt">Tiempo Alerta</div></div>
        <div class="metric" style="color:var(--accent)">2.3s</div>
        <div class="msub">detecci√≥n ‚Üí alerta &nbsp;<span class="tu">-40% vs SHOA</span></div>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="pt">Sismos Este Mes</div></div>
        <div class="metric">47</div>
        <div class="msub">registrados &nbsp;<span style="color:var(--muted)">‚Üë 8 &gt;4.0R</span></div>
      </div>
    </div>

    <div class="dash-grid g2">
      <div class="panel">
        <div class="panel-hd"><div class="pt">Actividad S√≠smica ‚Äî √öltimas 24h</div><button class="pa" onclick="redrawSeismic()">‚Üª Refresh</button></div>
        <canvas id="seismicChart" style="width:100%;height:140px"></canvas>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="pt">Intensidad por Zona (Mercalli)</div></div>
        <div id="mercalliPanel"></div>
      </div>
    </div>

    <div class="dash-grid g2">
      <div class="panel">
        <div class="panel-hd"><div class="pt">√öltimos Eventos Registrados</div></div>
        <div id="seismicFeed"></div>
      </div>
      <div class="panel">
        <div class="panel-hd"><div class="pt">Protocolo de Emergencia CityMesh</div></div>
        <div id="emergencyProtocol"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-ai" class="section">
  <div class="dashboard container">
    <div class="sec-hd">
      <div>
        <div class="sec-title">üß† M√≥dulos de IA ‚Äî Adaptados a Santiago</div>
        <div class="sec-sub">Entrenados con datos de la RM ¬∑ Federated Learning entre municipios ¬∑ Los datos nunca salen de Chile</div>
      </div>
    </div>
    <div class="ai-grid" id="aiGrid"></div>
    <div style="margin-top:1.25rem">
      <div class="panel">
        <div class="panel-hd">
          <div class="pt">FloodPredictor ‚Äî Canal San Carlos & Mapocho</div>
          <button class="pa" onclick="runFloodSim()">‚ñ∂ Simular escenario lluvia</button>
        </div>
        <canvas id="floodChart" style="width:100%;height:130px"></canvas>
        <div id="floodResult" style="margin-top:0.7rem;font-size:0.76rem;color:var(--muted)">Presiona "Simular escenario" para ver la predicci√≥n de inundaci√≥n en Santiago.</div>
      </div>
    </div>
    <div style="margin-top:1rem">
      <div class="panel">
        <div class="panel-hd">
          <div class="pt">Simulador Gossip Routing ‚Äî Red Santiago</div>
          <button class="pa" onclick="runGossipSim()">‚ñ∂ Simular propagaci√≥n</button>
        </div>
        <div id="gossipSim" style="padding:0.75rem;font-size:0.8rem;color:var(--muted);text-align:center">Presiona para ver c√≥mo un mensaje viaja desde Providencia hasta La Florida via gossip.</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROTOCOL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-protocol" class="section">
  <div class="proto-section container">
    <div class="sec-hd">
      <div>
        <div class="sec-title">Protocolo CityMesh ‚Äî RFC-001</div>
        <div class="sec-sub">Paquete de 64 bytes ¬∑ Compatible con LoRaWAN 1.1 ¬∑ Haz clic en cada campo</div>
      </div>
    </div>
    <div class="packet-viz">
      <div class="byte-row" id="byteRow"></div>
      <div id="byteDetail" style="margin-top:1.1rem;padding:0.9rem;background:var(--surface2);border-radius:9px;font-size:0.78rem;color:var(--muted);min-height:56px">
        üëÜ Haz clic en cualquier campo del paquete para ver su especificaci√≥n completa.
      </div>
    </div>
    <div style="margin-top:1.25rem">
      <div class="panel">
        <div class="panel-hd"><div class="pt">Cat√°logo de Tipos de Sensor</div><button class="pa" onclick="openModal('addSensor')">+ Proponer nuevo</button></div>
        <table class="stbl"><thead><tr><th>C√≥digo</th><th>Nombre</th><th>Descripci√≥n</th><th>Payload</th><th>Estado</th></tr></thead>
        <tbody id="sensorTbl"></tbody></table>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SDK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-sdk" class="section">
  <div class="dashboard container">
    <div class="sec-hd">
      <div>
        <div class="sec-title">SDK CityMesh ‚Äî Terminal Interactiva</div>
        <div class="sec-sub">Escribe comandos reales ¬∑ historial con ‚Üë‚Üì ¬∑ Conectado a red Santiago</div>
      </div>
    </div>
    <div class="terminal">
      <div class="term-bar">
        <div class="tdot" style="background:#ff5f57"></div>
        <div class="tdot" style="background:#ffbd2e"></div>
        <div class="tdot" style="background:#28ca41"></div>
        <span class="term-title">citymesh CLI v1.0.0 ¬∑ santiago.citymesh.cl ¬∑ conectado</span>
        <button class="term-clear" onclick="clearTerm()">limpiar</button>
      </div>
      <div class="term-body" id="TB">
        <div><span class="tm">CityMesh CLI v1.0.0 ‚Äî Red Santiago de Chile</span></div>
        <div><span class="tm">Nodo federado: santiago.citymesh.cl ¬∑ 412 nodos activos</span></div>
        <div><span class="tm">Comandos: flash ¬∑ register ¬∑ status ¬∑ list ¬∑ ping ¬∑ logs ¬∑ scan ¬∑ ai ¬∑ help</span></div>
        <div>&nbsp;</div>
      </div>
      <div class="term-input-row">
        <span class="tp">$&nbsp;</span>
        <input class="term-input" id="TI" placeholder="citymesh flash --port /dev/ttyUSB0 --region CL" onkeydown="handleKey(event)"/>
        <button class="term-run" onclick="runCmd()">Ejecutar ‚Üµ</button>
      </div>
    </div>
    <div style="margin-top:0.85rem;display:flex;gap:0.4rem;flex-wrap:wrap">
      <button class="map-btn" onclick="setCmd('citymesh flash --port /dev/ttyUSB0 --region CL --municipality providencia')">flash</button>
      <button class="map-btn" onclick="setCmd('citymesh register --gateway http://scl.citymesh.cl --sensor seismic')">register</button>
      <button class="map-btn" onclick="setCmd('citymesh status CM-CL-4a7f2b')">status</button>
      <button class="map-btn" onclick="setCmd('citymesh list --municipality providencia')">list</button>
      <button class="map-btn" onclick="setCmd('citymesh ping CM-CL-4a7f2b')">ping</button>
      <button class="map-btn" onclick="setCmd('citymesh logs CM-CL-1f8b --tail 10')">logs</button>
      <button class="map-btn" onclick="setCmd('citymesh scan --radius 500m --lat -33.4489 --lon -70.6693')">scan</button>
      <button class="map-btn" onclick="setCmd('citymesh ai --module FloodPredictor --node CM-CL-4a7f2b')">ai</button>
      <button class="map-btn" onclick="setCmd('citymesh help')">help</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROADMAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-roadmap" class="section">
  <div class="roadmap-section">
    <div class="container">
      <div class="sec-hd">
        <div>
          <div class="sec-title">üóì Hoja de Ruta ‚Äî CityMesh Santiago</div>
          <div class="sec-sub">Del prototipo al est√°ndar municipal. Haz clic en cada fase para el detalle.</div>
        </div>
      </div>
      <div class="roadmap">
        <div class="phase cur" onclick="openModal('p1')">
          <div class="ph-badge bc-now">‚óè EN CURSO</div>
          <div class="ph-num">Fase 1</div><div class="ph-name">MVP</div><div class="ph-time">Meses 1‚Äì3</div>
          <div class="ph-task"><span class="t-done">‚úì</span>Protocolo RFC-001</div>
          <div class="ph-task"><span class="t-done">‚úì</span>Firmware Rust ESP32</div>
          <div class="ph-task"><span class="t-done">‚úì</span>Gateway LoRa Santiago</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>CLI citymesh</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>Piloto Providencia</div>
        </div>
        <div class="phase" onclick="openModal('p2')">
          <div class="ph-badge bc-next">PR√ìXIMO</div>
          <div class="ph-num">Fase 2</div><div class="ph-name">Validaci√≥n</div><div class="ph-time">Meses 4‚Äì6</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>5 comunas piloto</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>Monitor s√≠smico live</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>AnomalyDetector activo</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>Integraci√≥n SHOA</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>API p√∫blica</div>
        </div>
        <div class="phase" onclick="openModal('p3')">
          <div class="ph-badge bc-fut">FUTURO</div>
          <div class="ph-num">Fase 3</div><div class="ph-name">Expansi√≥n</div><div class="ph-time">Meses 7‚Äì12</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>32 comunas RM</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>Federated Learning</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>Alerta temprana sismos</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>Integraci√≥n CONAF</div>
        </div>
        <div class="phase" onclick="openModal('p4')">
          <div class="ph-badge bc-fut">VISI√ìN</div>
          <div class="ph-num">Fase 4</div><div class="ph-name">Chile + LATAM</div><div class="ph-time">A√±o 2+</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>Red nacional Chile</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>Expansi√≥n a Per√∫, Argentina</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>RFC formal IETF</div>
          <div class="ph-task"><span class="t-pend">‚óã</span>El TCP/IP de ciudades</div>
        </div>
      </div>
      <div style="margin-top:1rem">
        <div style="font-size:0.7rem;color:var(--muted);margin-bottom:0.38rem">Progreso global ‚Äî 38% completado</div>
        <div class="prog-bar"><div class="pr-done" style="width:32%"></div><div class="pr-active" style="width:6%"></div><div class="pr-pend"></div></div>
      </div>
    </div>
  </div>
</div>

<footer>
  <strong>CityMesh Protocol RFC-001</strong> ¬∑ v1.0.0 ¬∑ Santiago de Chile ¬∑ Febrero 2026<br>
  <div class="flinks">
    <span class="fl" onclick="openModal('about')">¬øQu√© es CityMesh?</span>
    <span class="fl" onclick="nav('protocol')">Protocolo</span>
    <span class="fl" onclick="nav('sdk')">SDK</span>
    <span class="fl" onclick="openModal('license')">Apache 2.0</span>
    <span class="fl" onclick="nav('seismic')">Monitor S√≠smico</span>
    <span class="fl" onclick="nav('roadmap')">Roadmap</span>
  </div>
</footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COMUNAS=['Providencia','Santiago','√ëu√±oa','Las Condes','La Florida','Maip√∫','Pudahuel','Estaci√≥n Central','San Miguel','Vitacura','Lo Barnechea','Recoleta','Independencia','Cerro Navia','Lo Prado','Quinta Normal','Pedro Aguirre Cerda','La Pintana','El Bosque','La Granja'];

const NODES=[
  {id:'CM-CL-4a7f',type:'ok',left:'34%',top:'38%',sensor:'TEMPERATURE',value:'18.2¬∞C',loc:'Av. Providencia 1250',comuna:'Providencia',hops:1,rssi:'-82 dBm',ai:'Normal'},
  {id:'CM-CL-9c2d',type:'ok',left:'34%',top:'55%',sensor:'AIR_QUALITY',value:'31 ¬µg/m¬≥',loc:'Plaza de Armas',comuna:'Santiago',hops:2,rssi:'-88 dBm',ai:'Moderado'},
  {id:'CM-CL-1f8b',type:'alert',left:'18%',top:'55%',sensor:'WATER_LEVEL',value:'94mm ‚ö†',loc:'Canal San Carlos',comuna:'√ëu√±oa',hops:2,rssi:'-94 dBm',ai:'üö® Riesgo inundaci√≥n'},
  {id:'CM-CL-7e3a',type:'ok',left:'52%',top:'38%',sensor:'SEISMIC',value:'0.02 g',loc:'Av. Apoquindo 4500',comuna:'Las Condes',hops:1,rssi:'-77 dBm',ai:'Normal'},
  {id:'CM-CL-5d9f',type:'warn',left:'68%',top:'70%',sensor:'VIBRATION',value:'0.9 m/s¬≤',loc:'Av. Vicu√±a Mackenna',comuna:'La Florida',hops:3,rssi:'-91 dBm',ai:'‚ö† Vibraci√≥n moderada'},
  {id:'CM-CL-2b4c',type:'ok',left:'18%',top:'70%',sensor:'AIR_QUALITY',value:'58 ¬µg/m¬≥',loc:'Terminal Alameda',comuna:'Estaci√≥n Central',hops:2,rssi:'-85 dBm',ai:'‚ö† Umbral OMS superado'},
  {id:'CM-CL-8a1e',type:'offline',left:'52%',top:'55%',sensor:'SEISMIC',value:'‚Äî',loc:'Metro Baquedano',comuna:'Santiago',hops:0,rssi:'‚Äî',ai:'Sin datos'},
  {id:'CM-CL-6f2d',type:'ok',left:'34%',top:'70%',sensor:'TRAFFIC_FLOW',value:'524 veh/h',loc:'Gran Avenida',comuna:'San Miguel',hops:1,rssi:'-80 dBm',ai:'Normal'},
  {id:'CM-CL-3c7b',type:'warn',left:'82%',top:'38%',sensor:'NOISE_LEVEL',value:'78 dB',loc:'Av. Col√≥n',comuna:'Las Condes',hops:2,rssi:'-88 dBm',ai:'‚ö† Nivel elevado'},
  {id:'CM-CL-gw1',type:'gateway',left:'52%',top:'22%',sensor:'GATEWAY',value:'412 nodos',loc:'Cerro San Crist√≥bal',comuna:'Recoleta',hops:0,rssi:'-45 dBm',ai:'Gateway principal LoRa'},
  {id:'CM-CL-gw2',type:'gateway',left:'18%',top:'38%',sensor:'GATEWAY',value:'89 nodos',loc:'Centro C√≠vico',comuna:'Santiago',hops:0,rssi:'-52 dBm',ai:'Gateway secundario'},
  {id:'CM-CL-a1b2',type:'ok',left:'68%',top:'55%',sensor:'TEMPERATURE',value:'19.8¬∞C',loc:'Av. Grecia',comuna:'√ëu√±oa',hops:2,rssi:'-83 dBm',ai:'Normal'},
  {id:'CM-CL-c3d4',type:'alert',left:'18%',top:'83%',sensor:'AIR_QUALITY',value:'72 ¬µg/m¬≥',loc:'Av. La Pintana',comuna:'La Pintana',hops:3,rssi:'-96 dBm',ai:'üö® Calidad de aire da√±ina'},
];

const SENSORS=[
  {code:'0x01',name:'TEMPERATURE',desc:'Temperatura ambiente',format:'float32 (¬∞C)',status:'Estable'},
  {code:'0x02',name:'VIBRATION',desc:'Vibraci√≥n / impacto estructural',format:'float32 (m/s¬≤)',status:'Estable'},
  {code:'0x03',name:'WATER_LEVEL',desc:'Nivel de agua en cauces',format:'uint16 (mm)',status:'Estable'},
  {code:'0x04',name:'LUMINOSITY',desc:'Luminosidad ambiente',format:'uint16 (lux)',status:'Estable'},
  {code:'0x05',name:'AIR_QUALITY',desc:'Material particulado PM2.5',format:'float32 (¬µg/m¬≥)',status:'Estable'},
  {code:'0x06',name:'SEISMIC',desc:'Aceleraci√≥n s√≠smica (Chile)',format:'float32 (g)',status:'Estable'},
  {code:'0x07',name:'NOISE_LEVEL',desc:'Ruido ambiental',format:'float32 (dB)',status:'Estable'},
  {code:'0x08',name:'TRAFFIC_FLOW',desc:'Flujo vehicular',format:'uint16 (veh/h)',status:'Estable'},
  {code:'0x09',name:'POWER_USAGE',desc:'Consumo el√©ctrico',format:'float32 (kWh)',status:'Beta'},
  {code:'0x0A',name:'VOLCANO',desc:'Gases volc√°nicos SO2 (Chile)',format:'float32 (ppm)',status:'Beta'},
  {code:'0x0B',name:'TSUNAMI',desc:'Nivel de costa post-sismo',format:'uint16 (cm)',status:'Experimental'},
  {code:'0xFF',name:'CUSTOM',desc:'Tipo personalizado municipal',format:'bytes[46]',status:'Extensible'},
];

const AI_MODULES=[
  {icon:'üîç',name:'AnomalyDetector',algo:'Isolation Forest',desc:'Detecta lecturas fuera de rango en tiempo real con contexto hist√≥rico de 30 d√≠as. Calibrado para clima mediterr√°neo de Santiago.',acc:94,status:'Activo'},
  {icon:'üåä',name:'FloodPredictor',algo:'LSTM (PyTorch)',desc:'Predice inundaciones en r√≠os Mapocho y Canal San Carlos 2-4h antes. Entrenado con datos de aluviones 1997-2024.',acc:91,status:'Activo'},
  {icon:'üåã',name:'SeismicAlarm',algo:'CNN + Edge AI',desc:'Detecta patrones P-wave en microsegundos. Alerta 8-15s antes de onda S. Integrado con red SHOA de Chile.',acc:97,status:'Activo'},
  {icon:'üå¨',name:'SmogPredictor',algo:'XGBoost + Prophet',desc:'Predice episodios de contaminaci√≥n por MP2.5 en Gran Santiago. Considera viento, temperatura y tr√°fico.',acc:88,status:'Activo'},
  {icon:'üèó',name:'InfrastructureHealth',algo:'Random Forest',desc:'Clasifica estado de puentes, viaductos y edificios. Detecta da√±o s√≠smico acumulado. Prioriza inspecciones.',acc:90,status:'Activo'},
  {icon:'üö¶',name:'TrafficOptimizer',algo:'Reinforcement Learning',desc:'Optimiza sem√°foros en tiempo real. Coordinado con Transantiago/Red Metropolitana. Reduce congesti√≥n 31%.',acc:null,metric:'-31% espera',status:'Entrenando'},
  {icon:'üî•',name:'FireRisk',algo:'Random Forest + NDVI',desc:'Eval√∫a riesgo de incendios en precordillera. Combina temperatura, humedad, viento y vegetaci√≥n seca.',acc:86,status:'Activo'},
];

const BYTE_FIELDS=[
  {label:'node_id\n8 bytes',cls:'bc-id',bytes:8,title:'node_id ‚Äî 8 bytes',detail:'ID √∫nico generado al flashear. hash(MAC + GPS + timestamp). Inmutable. Formato: CM-CL-[hash6]. Ej: CM-CL-4a7f2b'},
  {label:'timestamp\n4 bytes',cls:'bc-ts',bytes:4,title:'timestamp ‚Äî 4 bytes',detail:'Unix timestamp uint32. Sincronizado via NTP en cada paso por gateway. Resoluci√≥n 1 segundo.'},
  {label:'type\n1B',cls:'bc-type',bytes:1,title:'sensor_type ‚Äî 1 byte',detail:'Tipo de sensor. 0x01-0x0B est√°ndar. 0xFF custom. Chile a√±adi√≥ 0x06 SEISMIC, 0x0A VOLCANO, 0x0B TSUNAMI.'},
  {label:'hop\n1B',cls:'bc-hop',bytes:1,title:'hop_count ‚Äî 1 byte',detail:'Saltos gossip realizados. M√°ximo 5. Si llega a 5 se descarta. Previene loops infinitos.'},
  {label:'flags\n1B',cls:'bc-flag',bytes:1,title:'flags ‚Äî 1 byte',detail:'Bits de control: bit0=urgencia, bit1=se√±al baja, bit2=bater√≠a cr√≠tica, bit3=sismo detectado, bit4=modo emergencia, bits5-7=reservados.'},
  {label:'payload ‚Äî 46 bytes',cls:'bc-pay',bytes:46,title:'payload ‚Äî 46 bytes',detail:'Datos del sensor. Formato depende del sensor_type. Para SEISMIC: aceleraci√≥n X,Y,Z en float32 (12 bytes) + frecuencia dominante (4 bytes). Resto 0x00.'},
  {label:'CRC24\n3 bytes',cls:'bc-crc',bytes:3,title:'CRC24 ‚Äî 3 bytes',detail:'Checksum CRC24. Tambi√©n ID √∫nico para deduplicaci√≥n en buffer gossip (256 entradas, TTL 60s). Si falla se descarta silenciosamente.'},
];

const TERM_CMDS={
  help:[
    {t:'i',v:'CityMesh CLI v1.0.0 ‚Äî Red Santiago de Chile'},
    {t:'m',v:'  flash      Flashear firmware en ESP32/RP2040'},
    {t:'m',v:'  register   Registrar nodo en nodo federado'},
    {t:'m',v:'  status     Ver estado de un nodo'},
    {t:'m',v:'  list       Listar nodos del municipio'},
    {t:'m',v:'  ping       Ping a un nodo'},
    {t:'m',v:'  logs       Ver lecturas recientes'},
    {t:'m',v:'  scan       Escanear nodos en radio'},
    {t:'m',v:'  ai         Ejecutar m√≥dulo de IA en nodo'},
    {t:'m',v:'  help       Esta ayuda'},
  ],
  flash:[
    {t:'m',v:'  ‚¨á Descargando firmware v1.0.0 para ESP32-S3...'},
    {t:'m',v:'  üîë Generando claves Ed25519...'},
    {t:'m',v:'  üìç GPS: lat -33.4489, lon -70.6693 (Providencia)'},
    {t:'m',v:'  üåã Habilitando sensor s√≠smico para zona CL-RM...'},
    {t:'m',v:'  üìù Escribiendo en flash...'},
    {t:'ok',v:'  ‚úÖ Flasheado ‚Üí ID: CM-CL-'+Math.random().toString(36).substr(2,4)},
  ],
  register:[
    {t:'m',v:'  üîó Conectando a santiago.citymesh.cl...'},
    {t:'m',v:'  ü§ù Auth JWT...'},
    {t:'m',v:'  üì° Gossip: 11 nodos vecinos en rango'},
    {t:'m',v:'  üåã Registrando en red s√≠smica SHOA-CityMesh...'},
    {t:'ok',v:'  ‚úÖ Nodo registrado ¬∑ Primera lectura en 30s'},
  ],
  status:[
    {t:'ok',v:'  ‚úÖ CM-CL-4a7f2b ‚Äî ACTIVO'},
    {t:'i',v:'  üì° RSSI: -82 dBm ¬∑ Hops: 2 ¬∑ Bater√≠a: 91%'},
    {t:'i',v:'  üå° Temp: 18.2¬∞C ¬∑ üåã Sismo: 0.02g (normal)'},
    {t:'m',v:'  üß† AnomalyDetector: Normal ¬∑ SeismicAlarm: Standby'},
    {t:'m',v:'  üìç Providencia ¬∑ Gateway: CM-CL-gw1 (2 hops)'},
  ],
  list:[
    {t:'i',v:'  Providencia ¬∑ 38 nodos activos de 40'},
    {t:'ok',v:'  CM-CL-4a7f  TEMPERATURE  18.2¬∞C   ‚úÖ'},
    {t:'ok',v:'  CM-CL-7e3a  SEISMIC      0.02g    ‚úÖ'},
    {t:'e',v:'  CM-CL-1f8b  WATER_LEVEL  94mm     üö® alerta'},
    {t:'w',v:'  CM-CL-5d9f  VIBRATION    0.9m/s¬≤  ‚ö†'},
    {t:'m',v:'  ... y 33 nodos m√°s ¬∑ --all para ver todos'},
  ],
  ping:[
    {t:'m',v:'  Enviando ping a CM-CL-4a7f2b...'},
    {t:'ok',v:'  PONG ¬∑ RTT: 285ms ¬∑ 2 hops ¬∑ RSSI: -82dBm'},
  ],
  logs:[
    {t:'m',v:'  [09:11:01] WATER_LEVEL=71mm canal_san_carlos hop=2'},
    {t:'m',v:'  [09:11:31] WATER_LEVEL=78mm ‚Üë tendencia'},
    {t:'w',v:'  [09:12:01] WATER_LEVEL=85mm ‚ö† sobre umbral 80mm'},
    {t:'w',v:'  [09:12:31] WATER_LEVEL=90mm ‚ö† AnomalyDetector activado'},
    {t:'e',v:'  [09:13:01] WATER_LEVEL=94mm üö® ALERTA ‚Äî FloodPredictor: 91% prob inundaci√≥n'},
  ],
  scan:[
    {t:'m',v:'  Escaneando radio 500m desde -33.4489, -70.6693...'},
    {t:'ok',v:'  CM-CL-4a7f  TEMPERATURE  -82dBm  Providencia'},
    {t:'ok',v:'  CM-CL-gw1   GATEWAY      -45dBm  Cerro San Crist√≥bal'},
    {t:'ok',v:'  CM-CL-9c2d  AIR_QUALITY  -88dBm  Santiago Centro'},
    {t:'w',v:'  CM-CL-8a1e  SEISMIC      offline  Metro Baquedano'},
    {t:'m',v:'  4 nodos encontrados ¬∑ 1 offline'},
  ],
  ai:[
    {t:'m',v:'  Ejecutando FloodPredictor en CM-CL-4a7f2b...'},
    {t:'m',v:'  Cargando historial 30 d√≠as Canal San Carlos...'},
    {t:'m',v:'  Procesando LSTM ¬∑ 3 capas ¬∑ seq_len=48h...'},
    {t:'w',v:'  ‚ö† Resultado: probabilidad inundaci√≥n 91% en 2.4h'},
    {t:'e',v:'  üö® Recomendaci√≥n: activar protocolo evacuaci√≥n Z3'},
  ],
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let curFilter='all', gossipOn=true, packetsOn=false, extraNodes=[], termHist=[], termIdx=-1, comunaIdx=0, packetInterval=null, currentSection='home';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function nav(name){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById('s-'+name).classList.add('active');
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  const map={home:'Inicio',dashboard:'Dashboard',seismic:'S√≠smico',ai:'IA',protocol:'Protocolo',sdk:'SDK',roadmap:'Roadmap'};
  document.querySelectorAll('.pill').forEach(p=>{if(p.textContent.trim().replace(/[^a-zA-Z√°√©√≠√≥√∫√ç√ë√±]/g,'')===map[name].replace(/[^a-zA-Z√°√©√≠√≥√∫√ç√ë√±]/g,''))p.classList.add('active');});
  currentSection=name;
  window.scrollTo(0,0);
  if(name==='dashboard')initDash();
  if(name==='seismic')initSeismic();
  if(name==='ai')initAI();
  if(name==='protocol')initProtocol();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARTICLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initParticles(){
  const c=document.getElementById('particles');
  for(let i=0;i<25;i++){
    const p=document.createElement('div');p.className='particle';
    p.style.cssText=`left:${Math.random()*100}%;animation-duration:${8+Math.random()*14}s;animation-delay:${Math.random()*12}s;width:${1+Math.random()*2}px;height:${1+Math.random()*2}px;background:${Math.random()>.5?'var(--accent)':'var(--accent2)'};`;
    c.appendChild(p);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMUNI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initComunas(){
  const strip=document.getElementById('comunaStrip');
  strip.innerHTML=COMUNAS.map(c=>`<div class="comune-chip" onclick="selectComuna('${c}',this)">${c}</div>`).join('');
}
function selectComuna(name,el){
  document.querySelectorAll('.comune-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  showToast('info','üèò '+name,'Filtrando nodos de '+name+'...');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMap(){
  const mc=document.getElementById('MC');
  mc.querySelectorAll('.mn').forEach(n=>n.remove());
  const all=[...NODES,...extraNodes];
  all.forEach(node=>{
    if(curFilter!=='all'&&node.type!==curFilter&&!(curFilter==='ok'&&node.type==='gateway'))return;
    const el=document.createElement('div');
    const sz=node.type==='gateway'?16:12;
    el.className=`mn n-${node.type}`;
    el.style.cssText=`left:${node.left};top:${node.top};width:${sz}px;height:${sz}px;`;
    el.title=node.id;
    el.addEventListener('click',()=>showPanel(node));
    mc.appendChild(el);
  });
  drawGossip();
  const vis=all.filter(n=>curFilter==='all'||n.type===curFilter||n.type==='gateway').length;
  document.getElementById('MCB').textContent=vis+' nodos ¬∑ 32 comunas';
}

function drawGossip(){
  const svg=document.getElementById('GSvg');svg.innerHTML='';
  if(!gossipOn)return;
  const conns=[[0,9,'active'],[1,10,'active'],[2,10,''],[3,9,''],[4,9,''],[5,10,'warn'],[6,9,''],[7,10,''],[8,9,''],[9,10,''],[0,1,''],[1,2,'warn'],[3,4,''],[4,5,'danger'],[11,9,'active'],[12,10,'danger'],[0,3,''],[1,6,'']];
  const all=[...NODES,...extraNodes];
  conns.forEach(([a,b,cls])=>{
    if(!all[a]||!all[b])return;
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    const ax=parseFloat(all[a].left)/100*900,ay=parseFloat(all[a].top)/100*460;
    const bx=parseFloat(all[b].left)/100*900,by=parseFloat(all[b].top)/100*460;
    line.setAttribute('x1',ax);line.setAttribute('y1',ay);
    line.setAttribute('x2',bx);line.setAttribute('y2',by);
    line.setAttribute('class','gl'+(cls?' gl-'+cls:''));
    line.setAttribute('stroke-dashoffset',Math.random()*20);
    svg.appendChild(line);
  });
}

function toggleGossip(){gossipOn=!gossipOn;drawGossip();showToast('info','üì° Gossip',gossipOn?'Visualizaci√≥n activada':'Visualizaci√≥n oculta');}

function togglePackets(){
  packetsOn=!packetsOn;
  if(packetsOn){
    packetInterval=setInterval(animPacket,1200);
    showToast('info','üì¶ Paquetes','Animaci√≥n de paquetes activada');
  } else {
    clearInterval(packetInterval);
    document.querySelectorAll('.pkt').forEach(p=>p.remove());
    showToast('info','üì¶ Paquetes','Animaci√≥n desactivada');
  }
}

function animPacket(){
  const mc=document.getElementById('MC');
  const nodes=[...NODES,...extraNodes].filter(n=>n.type!=='offline'&&n.type!=='gateway');
  if(nodes.length<2)return;
  const a=nodes[Math.floor(Math.random()*nodes.length)];
  const b=nodes[Math.floor(Math.random()*nodes.length)];
  if(a===b)return;
  const pkt=document.createElement('div');pkt.className='pkt';
  pkt.style.left=a.left;pkt.style.top=a.top;
  mc.appendChild(pkt);
  const sx=parseFloat(a.left),sy=parseFloat(a.top),ex=parseFloat(b.left),ey=parseFloat(b.top);
  let t=0;
  const anim=setInterval(()=>{
    t+=0.04;
    if(t>=1){clearInterval(anim);pkt.remove();return;}
    pkt.style.left=(sx+(ex-sx)*t)+'%';
    pkt.style.top=(sy+(ey-sy)*t)+'%';
  },16);
}

function flt(type,btn){
  curFilter=type;
  document.querySelectorAll('.map-controls .map-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');renderMap();
}

function addNode(){
  const types=['ok','warn','alert'],sensors=['TEMPERATURE','SEISMIC','AIR_QUALITY','WATER_LEVEL'];
  const n={id:'CM-CL-'+Math.random().toString(36).substr(2,4),type:types[Math.floor(Math.random()*3)],
    sensor:sensors[Math.floor(Math.random()*sensors.length)],left:(8+Math.random()*82)+'%',top:(8+Math.random()*80)+'%',
    value:'‚Äî',loc:'Nodo simulado',comuna:'Santiago',hops:Math.floor(Math.random()*4)+1,
    rssi:'-'+(75+Math.floor(Math.random()*25))+' dBm',ai:'Inicializando...'};
  extraNodes.push(n);renderMap();
  showToast('ok','‚úÖ Nodo agregado',n.id+' conectado a red Santiago');
}

function triggerEarthquake(){
  const mag=(3.5+Math.random()*4).toFixed(1);
  const zones=['Providencia','Las Condes','√ëu√±oa','La Florida','Maip√∫','Pudahuel','Santiago Centro'];
  const zone=zones[Math.floor(Math.random()*zones.length)];
  const fill=document.getElementById('seismicFill');
  const val=document.getElementById('seismicVal');
  const pct=Math.min(100,(parseFloat(mag)/9)*100);
  fill.style.width=pct+'%';
  const color=mag<4?'linear-gradient(90deg,var(--accent3),var(--warn))':mag<6?'linear-gradient(90deg,var(--warn),var(--danger))':'var(--danger)';
  fill.style.background=color;
  val.textContent=mag+' Richter ‚Äî '+zone;
  val.style.color=mag>=6?'var(--danger)':mag>=4?'var(--warn)':'var(--muted)';
  document.getElementById('MC').style.animation='shake 0.5s ease';
  setTimeout(()=>document.getElementById('MC').style.animation='',500);
  document.getElementById('last-mag').textContent=mag;
  document.getElementById('last-loc').textContent=zone;
  document.getElementById('last-time').textContent='ahora mismo';
  const sev=mag>=6?'err':mag>=4?'warn':'info';
  showToast(sev,'üåã Sismo Detectado','M'+mag+' Richter ¬∑ '+zone+' ¬∑ SeismicAlarm activado');
  setTimeout(()=>{fill.style.width='12%';fill.style.background='';val.textContent='0.8 Richter ‚Äî Normal';val.style.color='';},8000);
}

function showPanel(node){
  const colors={ok:'var(--accent3)',warn:'var(--warn)',alert:'var(--danger)',offline:'var(--muted)',gateway:'var(--accent)'};
  document.getElementById('NPH').textContent='‚¨§ '+node.id;
  document.getElementById('NPH').style.color=colors[node.type]||'var(--accent)';
  document.getElementById('NPC').innerHTML=`
    <div class="np-r"><span>Ubicaci√≥n</span><span class="np-v" style="font-size:0.65rem;text-align:right">${node.loc}</span></div>
    <div class="np-r"><span>Comuna</span><span class="np-v">${node.comuna}</span></div>
    <div class="np-r"><span>Sensor</span><span class="np-v">${node.sensor}</span></div>
    <div class="np-r"><span>Valor</span><span class="np-v" style="color:${node.type==='alert'?'var(--danger)':node.type==='warn'?'var(--warn)':'var(--text)'}">${node.value}</span></div>
    <div class="np-r"><span>Hops</span><span class="np-v">${node.hops}</span></div>
    <div class="np-r"><span>RSSI</span><span class="np-v">${node.rssi}</span></div>
    ${node.type!=='offline'?`<div class="np-ai" style="background:rgba(${node.type==='alert'?'239,68,68':'245,158,11'},0.08);color:${node.type==='alert'?'var(--danger)':node.type==='warn'?'var(--warn)':'var(--muted)'}">${node.ai}</div>`:''}`;
  document.getElementById('NP').classList.remove('hidden');
}
function closePanel(){document.getElementById('NP').classList.add('hidden');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MINI CHARTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawSpark(id,color,data){
  const c=document.getElementById(id);if(!c)return;
  const ctx=c.getContext('2d');const W=c.offsetWidth||200,H=46;
  c.width=W;c.height=H;ctx.clearRect(0,0,W,H);
  const mx=Math.max(...data),mn=Math.min(...data),rng=mx-mn||1;
  const pts=data.map((v,i)=>[i/(data.length-1)*W,H-((v-mn)/rng)*(H-8)-4]);
  const g=ctx.createLinearGradient(0,0,0,H);g.addColorStop(0,color+'44');g.addColorStop(1,color+'00');
  ctx.beginPath();ctx.moveTo(pts[0][0],H);
  pts.forEach(p=>ctx.lineTo(p[0],p[1]));
  ctx.lineTo(pts[pts.length-1][0],H);ctx.closePath();ctx.fillStyle=g;ctx.fill();
  ctx.beginPath();pts.forEach((p,i)=>i===0?ctx.moveTo(p[0],p[1]):ctx.lineTo(p[0],p[1]));
  ctx.strokeStyle=color;ctx.lineWidth=2;ctx.stroke();
}
function rnd(n,b,v){return Array.from({length:n},()=>b+(Math.random()-0.5)*v);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initDash(){
  setTimeout(()=>{
    drawSpark('ch-nodes','#10b981',rnd(24,410,15));
    drawSpark('ch-msgs','#00c8ff',rnd(24,84000,12000));
    drawSpark('ch-alerts','#ef4444',rnd(24,7,7));
    drawSpark('ch-ai','#7c3aed',rnd(24,32,8));
  },100);
  const bars=[
    {l:'üåã Actividad S√≠smica (CM-CL-7e3a)',v:8,cls:'f-ok',d:'0.02g'},
    {l:'üíß Nivel Agua Canal S.Carlos',v:94,cls:'f-crit',d:'94mm'},
    {l:'üå¨ PM2.5 Providencia',v:31,cls:'f-warn',d:'31¬µg/m¬≥'},
    {l:'üå° Temperatura promedio RM',v:40,cls:'f-ok',d:'18.2¬∞C'},
    {l:'üîä Ruido Las Condes',v:78,cls:'f-warn',d:'78dB'},
    {l:'üöó Tr√°fico Gran Avenida',v:65,cls:'f-blue',d:'524veh/h'},
    {l:'üå¨ PM2.5 La Pintana',v:72,cls:'f-crit',d:'72¬µg/m¬≥'},
    {l:'‚ö° Consumo el√©ctrico',v:45,cls:'f-purple',d:'3.8kWh'},
  ];
  document.getElementById('sBars').innerHTML=bars.map(b=>`
    <div class="pb-wrap">
      <div class="pb-hd"><span>${b.l}</span><span style="font-weight:600">${b.d}</span></div>
      <div class="pb-track"><div class="pb-fill ${b.cls}" style="width:${b.v}%"></div></div>
    </div>`).join('');
  renderAlerts();renderAQI();renderComunaStats();
}

function renderAlerts(){
  const alerts=[
    {icon:'üö®',cls:'crit',node:'CM-CL-1f8b ¬∑ Canal San Carlos, √ëu√±oa',text:'Nivel de agua 94mm. FloodPredictor: inundaci√≥n 91% probable en 2.4h',time:'hace 3 min',b:'b-crit',bl:'CR√çTICO'},
    {icon:'üå¨',cls:'crit',node:'CM-CL-c3d4 ¬∑ La Pintana',text:'PM2.5 72¬µg/m¬≥. Calidad de aire DA√ëINA para grupos vulnerables.',time:'hace 8 min',b:'b-crit',bl:'CR√çTICO'},
    {icon:'‚ö†Ô∏è',cls:'warn',node:'CM-CL-5d9f ¬∑ Av. Vicu√±a Mackenna, La Florida',text:'Vibraci√≥n an√≥mala 0.9 m/s¬≤. InfrastructureHealth: riesgo moderado.',time:'hace 12 min',b:'b-warn',bl:'ADVERTENCIA'},
    {icon:'üîä',cls:'warn',node:'CM-CL-3c7b ¬∑ Av. Col√≥n, Las Condes',text:'Ruido 78dB en horario nocturno. Sobre l√≠mite municipal (70dB).',time:'hace 19 min',b:'b-warn',bl:'ADVERTENCIA'},
    {icon:'üå¨',cls:'info',node:'CM-CL-2b4c ¬∑ Terminal Alameda, Estaci√≥n Central',text:'PM2.5 58¬µg/m¬≥. Sobre umbral OMS 25¬µg/m¬≥. Episodio de contaminaci√≥n.',time:'hace 31 min',b:'b-info',bl:'INFO'},
  ];
  document.getElementById('aFeed').innerHTML=alerts.map(a=>`
    <div class="af-item ${a.cls}" onclick="dismissAlert(this)">
      <div class="af-icon">${a.icon}</div>
      <div class="af-body">
        <div class="af-node">${a.node}</div>
        <div class="af-text">${a.text}</div>
        <div class="af-time">${a.time}</div>
      </div>
      <span class="af-badge ${a.b}">${a.bl}</span>
    </div>`).join('');
}

function renderAQI(){
  const data=[
    {comuna:'Las Condes',aqi:28,cls:'f-warn'},
    {comuna:'Providencia',aqi:31,cls:'f-warn'},
    {comuna:'Santiago',aqi:41,cls:'f-warn'},
    {comuna:'Maip√∫',aqi:45,cls:'f-warn'},
    {comuna:'Est. Central',aqi:58,cls:'f-crit'},
    {comuna:'La Pintana',aqi:72,cls:'f-crit'},
    {comuna:'Pudahuel',aqi:19,cls:'f-ok'},
    {comuna:'Vitacura',aqi:15,cls:'f-ok'},
  ];
  document.getElementById('aqiPanel').innerHTML=data.map(d=>`
    <div class="pb-wrap">
      <div class="pb-hd"><span>${d.comuna}</span><span style="font-weight:600;color:${d.aqi>50?'var(--danger)':d.aqi>25?'var(--warn)':'var(--accent3)'}">${d.aqi} ¬µg/m¬≥</span></div>
      <div class="pb-track"><div class="pb-fill ${d.cls}" style="width:${Math.min(100,(d.aqi/100)*100)}%"></div></div>
    </div>`).join('');
}

let _ci=0;
const CSTATS=[
  {c:'Providencia',nodes:38,ok:36,alert:2,pop:'148K',sensor:'TEMPERATURE',top:'18.2¬∞C'},
  {c:'Las Condes',nodes:52,ok:49,alert:3,pop:'299K',sensor:'SEISMIC',top:'0.02g'},
  {c:'Santiago',nodes:45,ok:41,alert:4,pop:'404K',sensor:'AIR_QUALITY',top:'41¬µg/m¬≥'},
  {c:'La Florida',nodes:41,ok:38,alert:3,pop:'366K',sensor:'TRAFFIC_FLOW',top:'524veh/h'},
  {c:'Maip√∫',nodes:38,ok:35,alert:3,pop:'468K',sensor:'AIR_QUALITY',top:'45¬µg/m¬≥'},
];
function renderComunaStats(){
  const d=CSTATS[_ci%CSTATS.length];
  document.getElementById('comunaStats').innerHTML=`
    <div style="font-size:1.4rem;font-weight:800;color:var(--accent);margin-bottom:0.3rem">${d.c}</div>
    <div class="pb-wrap"><div class="pb-hd"><span>Nodos activos</span><span>${d.ok}/${d.nodes}</span></div><div class="pb-track"><div class="pb-fill f-ok" style="width:${(d.ok/d.nodes)*100}%"></div></div></div>
    <div class="pb-wrap"><div class="pb-hd"><span>Alertas activas</span><span style="color:var(--danger)">${d.alert}</span></div><div class="pb-track"><div class="pb-fill f-crit" style="width:${(d.alert/d.nodes)*100}%"></div></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-top:0.75rem">
      <div style="background:var(--surface2);border-radius:8px;padding:0.6rem;text-align:center">
        <div style="font-size:1.1rem;font-weight:800">${d.pop}</div>
        <div style="font-size:0.65rem;color:var(--muted)">Habitantes</div>
      </div>
      <div style="background:var(--surface2);border-radius:8px;padding:0.6rem;text-align:center">
        <div style="font-size:1.1rem;font-weight:800;color:var(--accent)">${d.top}</div>
        <div style="font-size:0.65rem;color:var(--muted)">${d.sensor}</div>
      </div>
    </div>`;
}
function rotateComuna(){_ci++;renderComunaStats();showToast('info','üèò Estad√≠sticas',CSTATS[_ci%CSTATS.length].c);}

function dismissAlert(el){el.style.opacity='0.35';el.style.pointerEvents='none';showToast('ok','‚úÖ Alerta atendida','Marcada como revisada');}
function markRead(){document.querySelectorAll('.af-item').forEach(a=>{a.style.opacity='0.35';a.style.pointerEvents='none';});showToast('ok','‚úÖ Todas atendidas','Feed limpio');}
function refreshBars(){document.querySelectorAll('.pb-fill').forEach(f=>{f.style.width=Math.max(3,Math.min(100,parseFloat(f.style.width)+(Math.random()-0.5)*18))+'%';});showToast('info','‚Üª Actualizado','Lecturas refrescadas');}
function setTR(r,btn){document.querySelectorAll('[onclick^="setTR"]').forEach(b=>b.classList.remove('on'));btn.classList.add('on');drawSpark('ch-nodes','#10b981',rnd(24,410,15));drawSpark('ch-msgs','#00c8ff',rnd(24,84000,12000));showToast('info','üìä '+r,'Rango actualizado');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEISMIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initSeismic(){
  setTimeout(()=>{redrawSeismic();},100);
  const zones=[
    {z:'I ‚Äî Leve',color:'var(--accent3)',desc:'Prado Leal, Lo Barnechea',val:2},
    {z:'III ‚Äî Perceptible',color:'var(--accent)',desc:'Las Condes, Vitacura',val:30},
    {z:'V ‚Äî Moderado',color:'var(--warn)',desc:'Providencia, √ëu√±oa',val:55},
    {z:'VI ‚Äî Fuerte',color:'var(--danger)',desc:'Santiago, Maip√∫',val:70},
  ];
  document.getElementById('mercalliPanel').innerHTML=zones.map(z=>`
    <div class="pb-wrap">
      <div class="pb-hd"><span style="color:${z.color}">${z.z}</span><span style="font-size:0.7rem;color:var(--muted)">${z.desc}</span></div>
      <div class="pb-track"><div class="pb-fill" style="width:${z.val}%;background:${z.color}"></div></div>
    </div>`).join('');

  const events=[
    {mag:'3.2',depth:'12km',loc:'Pudahuel',time:'hace 4h',tipo:'Tect√≥nico'},
    {mag:'2.8',depth:'8km',loc:'Maip√∫',time:'hace 9h',tipo:'Tect√≥nico'},
    {mag:'4.1',depth:'25km',loc:'San Bernardo',time:'hace 16h',tipo:'Tect√≥nico'},
    {mag:'2.1',depth:'5km',loc:'Cerro Navia',time:'hace 22h',tipo:'Superficial'},
    {mag:'3.7',depth:'18km',loc:'Pe√±aflor',time:'hace 31h',tipo:'Tect√≥nico'},
  ];
  document.getElementById('seismicFeed').innerHTML=events.map(e=>`
    <div class="af-item ${parseFloat(e.mag)>=4?'warn':''}" style="margin-bottom:0.4rem">
      <div class="af-icon">${parseFloat(e.mag)>=4?'üåã':'üü°'}</div>
      <div class="af-body">
        <div class="af-node">M${e.mag} ‚Äî ${e.loc}</div>
        <div class="af-text">Profundidad ${e.depth} ¬∑ ${e.tipo}</div>
        <div class="af-time">${e.time}</div>
      </div>
      <span class="af-badge ${parseFloat(e.mag)>=4?'b-warn':'b-ok'}">${e.mag}R</span>
    </div>`).join('');

  document.getElementById('emergencyProtocol').innerHTML=`
    <div style="font-size:0.78rem;line-height:1.8">
      <div style="margin-bottom:0.75rem;color:var(--muted)">Protocolo autom√°tico seg√∫n magnitud:</div>
      <div class="pb-wrap"><div class="pb-hd"><span style="color:var(--accent3)">M &lt; 4.0</span><span>Registro + Log</span></div><div style="font-size:0.7rem;color:var(--muted)">Solo almacenamiento en TimescaleDB. Sin alertas.</div></div>
      <div class="pb-wrap"><div class="pb-hd"><span style="color:var(--warn)">M 4.0‚Äì5.9</span><span>Alerta preventiva</span></div><div style="font-size:0.7rem;color:var(--muted)">Notificaci√≥n a municipios afectados. InfrastructureHealth activado.</div></div>
      <div class="pb-wrap"><div class="pb-hd"><span style="color:var(--danger)">M ‚â• 6.0</span><span>Emergencia Mayor</span></div><div style="font-size:0.7rem;color:var(--muted)">Integraci√≥n ONEMI + SHOA. Protocolo tsunami si epicentro costa. Evacuaci√≥n autom√°tica Z3.</div></div>
    </div>`;
}

function redrawSeismic(){
  const c=document.getElementById('seismicChart');if(!c)return;
  const ctx=c.getContext('2d');const W=c.offsetWidth||400,H=140;
  c.width=W;c.height=H;ctx.clearRect(0,0,W,H);
  const data=rnd(48,0.8,2.5).map(v=>Math.max(0.1,v));
  data[18]=4.1;data[19]=3.2;data[32]=2.8;data[41]=3.7;
  const mx=Math.max(...data);
  const g=ctx.createLinearGradient(0,0,0,H);g.addColorStop(0,'rgba(0,200,255,0.3)');g.addColorStop(1,'rgba(0,200,255,0)');
  ctx.beginPath();
  data.forEach((v,i)=>{const x=i/(data.length-1)*W,y=H-(v/mx)*(H-12)-6;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fillStyle=g;ctx.fill();
  ctx.beginPath();
  data.forEach((v,i)=>{const x=i/(data.length-1)*W,y=H-(v/mx)*(H-12)-6;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.strokeStyle='var(--accent)';ctx.lineWidth=1.5;ctx.stroke();
  [18,19,32,41].forEach(i=>{
    const x=i/(data.length-1)*W,y=H-(data[i]/mx)*(H-12)-6;
    ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);
    ctx.fillStyle=data[i]>=4?'var(--danger)':'var(--warn)';ctx.fill();
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initAI(){
  document.getElementById('aiGrid').innerHTML=AI_MODULES.map(m=>`
    <div class="ai-card${m.status==='Entrenando'?' running':''}">
      <div class="ai-icon">${m.icon}</div>
      <div class="ai-name">${m.name}</div>
      <div class="ai-algo">${m.algo}</div>
      <div class="ai-desc">${m.desc}</div>
      <div class="ai-stat">
        <div class="ai-dot${m.status==='Entrenando'?' pulse':''}"></div>
        <span style="color:var(--muted)">${m.status}</span>
        ${m.acc?`<span style="margin-left:auto;color:var(--accent3)">${m.acc}%</span>`:`<span style="margin-left:auto;color:var(--warn)">${m.metric}</span>`}
      </div>
      ${m.acc?`<div class="ai-acc-bar"><div class="ai-acc-fill" style="width:${m.acc}%"></div></div>`:''}
      <button class="ai-run-btn${m.status==='Entrenando'?' running':''}" onclick="runAI('${m.name}',this)">${m.status==='Entrenando'?'‚è≥ Entrenando...':'‚ñ∂ Ejecutar inferencia'}</button>
    </div>`).join('');
}

function runAI(name,btn){
  btn.textContent='‚è≥ Procesando...';btn.classList.add('running');
  const msgs={
    AnomalyDetector:'Sin anomal√≠as en √∫ltimos 10 min. Todos los nodos dentro de par√°metros.',
    FloodPredictor:'‚ö† Riesgo ALTO en Canal San Carlos. 91% prob. inundaci√≥n en 2.4h.',
    SeismicAlarm:'Red s√≠smica operativa. Umbral alerta: M4.0. √öltima calibraci√≥n: 08:00h.',
    SmogPredictor:'Episodio contaminaci√≥n probable 15:00-20:00h. La Pintana, Est. Central.',
    InfrastructureHealth:'Viaducto Am√©rico Vespucio Sur: RIESGO MODERADO. Inspecci√≥n en 48h.',
    TrafficOptimizer:'Alameda optimizada. -28% espera en Baquedano-Tobalaba.',
    FireRisk:'Precordillera Las Condes: Riesgo ALTO. Viento Puelche + vegetaci√≥n seca.',
  };
  setTimeout(()=>{
    btn.textContent='‚úÖ Completado';
    showToast('ok','üß† '+name,msgs[name]||'Inferencia completada.');
    setTimeout(()=>{btn.textContent='‚ñ∂ Ejecutar inferencia';btn.classList.remove('running');},2000);
  },2000);
}

function runFloodSim(){
  const c=document.getElementById('floodChart');if(!c)return;
  const ctx=c.getContext('2d');const W=c.offsetWidth||400,H=130;
  c.width=W;c.height=H;ctx.clearRect(0,0,W,H);
  const data=[15,18,22,28,36,48,65,80,94,105,98,82],th=80,mx=120,n=data.length;
  ctx.fillStyle='rgba(239,68,68,0.05)';ctx.fillRect(0,H-(th/mx)*H,W,(th/mx)*H);
  ctx.strokeStyle='rgba(239,68,68,0.4)';ctx.setLineDash([4,4]);
  ctx.beginPath();ctx.moveTo(0,H-(th/mx)*H);ctx.lineTo(W,H-(th/mx)*H);ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle='rgba(59,130,246,0.08)';
  ctx.fillRect(0,0,W,H-(th/mx)*H);
  const g=ctx.createLinearGradient(0,0,0,H);g.addColorStop(0,'rgba(0,200,255,0.3)');g.addColorStop(1,'rgba(0,200,255,0)');
  ctx.beginPath();
  data.forEach((v,i)=>{const x=i/(n-1)*W,y=H-(v/mx)*H;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fillStyle=g;ctx.fill();
  ctx.beginPath();
  data.forEach((v,i)=>{const x=i/(n-1)*W,y=H-(v/mx)*H;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
  ctx.strokeStyle='var(--accent)';ctx.lineWidth=2;ctx.stroke();
  document.getElementById('floodResult').innerHTML=`<span style="color:var(--danger);font-weight:700">üö® ALERTA: </span>FloodPredictor proyecta nivel cr√≠tico en Canal San Carlos (80mm) en ~2.4h. Probabilidad 91%. <span style="color:var(--accent)">Recomendaci√≥n: activar protocolo de drenaje preventivo y alertar a comunas √ëu√±oa y Providencia.</span>`;
  showToast('warn','üåä FloodPredictor','Riesgo inundaci√≥n ALTO ‚Äî Canal San Carlos');
}

function runGossipSim(){
  const area=document.getElementById('gossipSim');
  const steps=[
    'üì° CM-CL-1f8b (Canal San Carlos) emite alerta ¬∑ WATER_LEVEL=94mm ¬∑ hop=0',
    '‚Üí Vecinos: CM-CL-4a7f (Providencia), CM-CL-9c2d (Santiago) ¬∑ 2 nodos en rango',
    '‚Üí CM-CL-4a7f: ‚úÖ CRC24 v√°lido ¬∑ hop‚Üí1 ¬∑ retransmite hacia Gateway SCL',
    '‚Üí CM-CL-9c2d: ‚úÖ CRC24 v√°lido ¬∑ hop‚Üí1 ¬∑ retransmite hacia La Florida',
    '‚Üí CM-CL-5d9f (La Florida): recibe por 2 rutas ¬∑ descarta duplicado ¬∑ hop‚Üí2',
    '‚Üí CM-CL-gw1 (Cerro San Crist√≥bal): recibe paquete ¬∑ RSSI: -88dBm',
    '‚òÅÔ∏è Gateway sube a santiago.citymesh.cl via HTTPS + JWT',
    'üß† FloodPredictor: WATER_LEVEL 94mm > umbral 80mm ‚Üí inundaci√≥n 91%',
    'üåã SeismicAlarm: verificando correlaci√≥n con actividad s√≠smica ‚Üí negativo',
    'üö® Alerta generada ¬∑ ONEMI notificado ¬∑ Dashboard actualizado',
    '‚úÖ Propagaci√≥n: 4 hops ¬∑ 8 comunas alertadas ¬∑ 210ms total ¬∑ 0 p√©rdidas',
  ];
  let i=0;
  area.innerHTML='<div style="text-align:left;font-family:monospace;font-size:0.73rem;line-height:1.9;overflow-y:auto;max-height:200px"></div>';
  const div=area.querySelector('div');
  const iv=setInterval(()=>{
    if(i>=steps.length){clearInterval(iv);return;}
    const c=steps[i].startsWith('üö®')?'var(--danger)':steps[i].startsWith('‚úÖ')?'var(--accent3)':steps[i].startsWith('‚ö†')||steps[i].startsWith('‚Üí')?'var(--warn)':steps[i].startsWith('üß†')||steps[i].startsWith('üåã')?'var(--accent2)':'var(--muted)';
    div.innerHTML+=`<div style="color:${c}">${steps[i]}</div>`;
    div.scrollTop=div.scrollHeight;i++;
  },360);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROTOCOL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initProtocol(){
  const row=document.getElementById('byteRow');row.innerHTML='';
  BYTE_FIELDS.forEach(f=>{
    const c=document.createElement('div');c.className='bc '+f.cls;
    c.style.width=Math.max(44,f.bytes*12)+'px';
    c.innerHTML=`<span style="white-space:pre-wrap;text-align:center;line-height:1.3">${f.label}</span><div class="bc-tip">${f.title}</div>`;
    c.addEventListener('click',()=>{document.getElementById('byteDetail').innerHTML=`<strong style="color:var(--text)">${f.title}</strong><br><br><span>${f.detail}</span>`;});
    row.appendChild(c);
  });
  document.getElementById('sensorTbl').innerHTML=SENSORS.map(s=>`
    <tr onclick="showToast('info','${s.name}','${s.desc} ¬∑ ${s.format}')">
      <td><span class="ctag">${s.code}</span></td>
      <td style="font-weight:600">${s.name}</td>
      <td style="color:var(--muted)">${s.desc}</td>
      <td style="font-family:monospace;font-size:0.7rem">${s.format}</td>
      <td><span class="af-badge ${s.status==='Estable'?'b-ok':s.status==='Beta'?'b-warn':'b-info'}">${s.status}</span></td>
    </tr>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TERMINAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function writeT(cls,text){
  const b=document.getElementById('TB');
  const d=document.createElement('div');
  d.innerHTML=`<span class="t${cls}">${text}</span>`;
  b.appendChild(d);b.scrollTop=b.scrollHeight;
}
function runCmd(){
  const inp=document.getElementById('TI');const cmd=inp.value.trim();if(!cmd)return;
  termHist.unshift(cmd);termIdx=-1;
  const d=document.createElement('div');
  d.innerHTML=`<span class="tp">$ </span><span class="tc">${cmd}</span>`;
  document.getElementById('TB').appendChild(d);
  const key=Object.keys(TERM_CMDS).find(k=>cmd.includes(k));
  if(key){TERM_CMDS[key].forEach((l,i)=>setTimeout(()=>writeT(l.t,l.v),i*200));}
  else writeT('e','  Error: comando no reconocido. Escribe "citymesh help".');
  inp.value='';
}
function handleKey(e){
  if(e.key==='Enter')runCmd();
  if(e.key==='ArrowUp'){termIdx=Math.min(termIdx+1,termHist.length-1);document.getElementById('TI').value=termHist[termIdx]||'';}
  if(e.key==='ArrowDown'){termIdx=Math.max(termIdx-1,-1);document.getElementById('TI').value=termIdx>=0?termHist[termIdx]:'';}
}
function setCmd(c){document.getElementById('TI').value=c;document.getElementById('TI').focus();}
function clearTerm(){document.getElementById('TB').innerHTML='<div><span class="tm">Terminal limpiada. Listo.</span></div>';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(type,title,msg){
  const c=document.getElementById('TC');
  const t=document.createElement('div');
  const icons={info:'‚ÑπÔ∏è',ok:'‚úÖ',warn:'‚ö†Ô∏è',err:'üö®'};
  t.className=`toast t${type}`;
  t.innerHTML=`<div class="toast-icon">${icons[type]||'‚ÑπÔ∏è'}</div><div class="toast-body"><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div></div><button class="toast-x" onclick="this.parentElement.remove()">‚úï</button>`;
  c.appendChild(t);setTimeout(()=>t.remove(),5200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MODALS={
  about:{title:'¬øQu√© es CityMesh Santiago?',body:`CityMesh es un protocolo de comunicaci√≥n abierto y federado dise√±ado especialmente para el contexto chileno: <strong>sismos, aluviones, smog y terremoto urbano</strong>.<br><br>412 nodos cubren 32 comunas de la Regi√≥n Metropolitana. Cada nodo cuesta $1-5 USD y se instala en 15 minutos. El dato m√°s importante: <strong>ning√∫n dato sale de Chile sin autorizaci√≥n expl√≠cita del municipio.</strong><br><br>El objetivo a largo plazo: ser el est√°ndar de comunicaci√≥n entre dispositivos urbanos en toda Latinoam√©rica, comenzando desde Santiago.`,footer:`<button class="btn-secondary" onclick="closeModal()">Cerrar</button><button class="btn-primary" onclick="closeModal();nav('protocol')">Ver Protocolo ‚Üí</button>`},
  deploy:{title:'+ Desplegar Nuevo Nodo en Santiago',body:`<div style="margin-bottom:0.9rem">Hardware requerido:</div><div style="background:var(--surface2);border-radius:9px;padding:0.9rem;margin-bottom:0.9rem;font-size:0.8rem"><div style="color:var(--accent3);font-weight:700;margin-bottom:0.4rem">Lista de componentes (~$8 USD total)</div><div style="color:var(--muted)">‚Ä¢ ESP32-S3 ($2 USD) ‚Äî Incluye WiFi + BLE<br>‚Ä¢ M√≥dulo LoRa SX1276 ($3 USD) ‚Äî 15km rango<br>‚Ä¢ Sensor s√≠smico ADXL345 ($2 USD) ‚Äî Para zona s√≠smica<br>‚Ä¢ Panel solar 5V ($1 USD) + bater√≠a LiPo</div></div><div style="background:var(--surface2);border-radius:9px;padding:0.9rem;font-size:0.8rem"><div style="color:var(--accent);font-weight:700;margin-bottom:0.4rem">Instalaci√≥n en 3 comandos</div><div style="font-family:monospace;font-size:0.72rem;color:var(--muted);line-height:2.2">citymesh flash --port /dev/ttyUSB0 --region CL<br>citymesh register --gateway http://scl.citymesh.cl<br>citymesh status [NODE_ID]</div></div>`,footer:`<button class="btn-secondary" onclick="closeModal()">Cerrar</button><button class="btn-primary" onclick="closeModal();nav('sdk')">Abrir SDK ‚Üí</button>`},
  alerts:{title:'Todas las Alertas Activas (8)',body:`<div style="font-size:0.8rem;color:var(--muted);margin-bottom:0.9rem">Regi√≥n Metropolitana ¬∑ Actualizado hace 3 min</div>
    <div style="background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.2);border-radius:9px;padding:0.7rem;margin-bottom:0.45rem;font-size:0.78rem">üö® <strong>CM-CL-1f8b</strong> ‚Äî Canal San Carlos 94mm ‚Äî Riesgo inundaci√≥n 2.4h</div>
    <div style="background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.2);border-radius:9px;padding:0.7rem;margin-bottom:0.45rem;font-size:0.78rem">üö® <strong>CM-CL-c3d4</strong> ‚Äî La Pintana PM2.5 72¬µg/m¬≥ ‚Äî Calidad da√±ina</div>
    <div style="background:rgba(245,158,11,0.07);border:1px solid rgba(245,158,11,0.2);border-radius:9px;padding:0.7rem;margin-bottom:0.45rem;font-size:0.78rem">‚ö†Ô∏è <strong>CM-CL-5d9f</strong> ‚Äî Vibraci√≥n 0.9m/s¬≤ La Florida ‚Äî Riesgo moderado</div>
    <div style="background:rgba(245,158,11,0.07);border:1px solid rgba(245,158,11,0.2);border-radius:9px;padding:0.7rem;margin-bottom:0.45rem;font-size:0.78km">‚ö†Ô∏è <strong>CM-CL-3c7b</strong> ‚Äî Ruido 78dB nocturno Las Condes</div>
    <div style="background:rgba(59,130,246,0.07);border:1px solid rgba(59,130,246,0.2);border-radius:9px;padding:0.7rem;font-size:0.78rem">‚ÑπÔ∏è <strong>CM-CL-2b4c</strong> ‚Äî PM2.5 58¬µg/m¬≥ Estaci√≥n Central</div>`,footer:`<button class="btn-secondary" onclick="closeModal()">Cerrar</button><button class="btn-primary" onclick="closeModal();markRead()">Marcar todas atendidas</button>`},
  addSensor:{title:'+ Proponer nuevo tipo de sensor',body:`Chile ya contribuy√≥ 3 tipos al cat√°logo oficial: <strong>0x06 SEISMIC</strong>, <strong>0x0A VOLCANO</strong>, <strong>0x0B TSUNAMI</strong>.<br><br>Para proponer un nuevo tipo abre un Pull Request con:<br><br><div style="background:var(--surface2);border-radius:9px;padding:0.9rem;font-family:monospace;font-size:0.72rem;color:var(--muted);line-height:2">sensor_type: 0x0C<br>name: RAINFALL<br>description: Precipitaci√≥n pluviom√©trica<br>unit: mm/h<br>payload_format: float32<br>range: [0.0, 300.0]<br>municipio_piloto: santiago-CL</div><br>Revisi√≥n de la comunidad: 30 d√≠as.`,footer:`<button class="btn-secondary" onclick="closeModal()">Cerrar</button><button class="btn-primary" onclick="closeModal();showToast('ok','üîó GitHub','Abriendo repositorio...')">Abrir en GitHub ‚Üí</button>`},
  license:{title:'Licencia Apache 2.0',body:`CityMesh es open source bajo Apache 2.0.<br><br><strong style="color:var(--accent3)">Puedes:</strong> usar en producci√≥n, modificar, distribuir, uso comercial.<br><br><strong style="color:var(--warn)">Debes:</strong> mantener copyright, incluir licencia, documentar cambios.<br><br>El nombre "CityMesh" y el logo est√°n protegidos. Los tipos de sensor chilenos (SEISMIC, VOLCANO, TSUNAMI) son contribuci√≥n de la comunidad CL bajo Apache 2.0.`,footer:`<button class="btn-primary" onclick="closeModal()">Entendido</button>`},
  p1:{title:'Fase 1 ‚Äî MVP (Meses 1-3)',body:'Fundamentos t√©cnicos del protocolo. <br><br><strong style="color:var(--accent3)">Completado:</strong> Protocolo RFC-001, firmware Rust ESP32-S3 con soporte s√≠smico, gateway LoRa instalado en Cerro San Crist√≥bal.<br><br><strong style="color:var(--warn)">En progreso:</strong> CLI citymesh, piloto de 40 nodos en Providencia, integraci√≥n con API SHOA.',footer:`<button class="btn-secondary" onclick="closeModal()">Cerrar</button><button class="btn-primary" onclick="closeModal();nav('sdk')">SDK ‚Üí</button>`},
  p2:{title:'Fase 2 ‚Äî Validaci√≥n (Meses 4-6)',body:'5 comunas piloto: Providencia, Santiago, Las Condes, Maip√∫, La Florida. Monitor s√≠smico en tiempo real integrado con SHOA. AnomalyDetector activo en todos los nodos.',footer:'<button class="btn-primary" onclick="closeModal()">Cerrar</button>'},
  p3:{title:'Fase 3 ‚Äî Expansi√≥n RM (Meses 7-12)',body:'32 comunas de la Regi√≥n Metropolitana. Federated Learning entre municipios. Alerta temprana s√≠smica integrada con ONEMI. Integraci√≥n con CONAF para riesgo de incendios en precordillera.',footer:'<button class="btn-primary" onclick="closeModal()">Cerrar</button>'},
  p4:{title:'Fase 4 ‚Äî Chile + LATAM (A√±o 2+)',body:'Red nacional Chile: Santiago, Valpara√≠so, Concepci√≥n, Antofagasta. Expansi√≥n a Per√∫, Argentina, Colombia. RFC formal IETF. Fundaci√≥n CityMesh Latinoam√©rica. El TCP/IP de las ciudades f√≠sicas de Am√©rica Latina.',footer:'<button class="btn-primary" onclick="closeModal()">Entendido</button>'},
};
function openModal(k){const m=MODALS[k];if(!m)return;document.getElementById('MT').textContent=m.title;document.getElementById('MB').innerHTML=m.body;document.getElementById('MF').innerHTML=m.footer;document.getElementById('MO').classList.add('open');}
function closeModal(){document.getElementById('MO').classList.remove('open');}
document.getElementById('MO').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIVE COUNTERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _upd=3;
setInterval(()=>{
  _upd++;
  const e=document.getElementById('upd');if(e)e.textContent=_upd;
  if(_upd>=30){
    _upd=0;
    const dn=document.getElementById('d-nodes');if(dn)dn.textContent=408+Math.floor(Math.random()*8);
    const dm=document.getElementById('d-msgs');if(dm)dm.textContent=(82+Math.floor(Math.random()*6))+'.'+Math.floor(Math.random()*9)+'K';
  }
},1000);
let _sn=350;
setInterval(()=>{_sn=Math.min(412,_sn+Math.floor(Math.random()*4));const e=document.getElementById('sn-nodes');if(e)e.textContent=_sn;},1800);

// Seismic subtle animation
setInterval(()=>{
  const fill=document.getElementById('seismicFill');
  const val=document.getElementById('seismicVal');
  if(!fill||!val)return;
  const base=0.5+Math.random()*1.5;
  fill.style.width=Math.min(100,(base/9)*100*3)+'%';
},3000);

// CSS shake animation
const style=document.createElement('style');
style.textContent='@keyframes shake{0%,100%{transform:translateX(0)}10%,50%,90%{transform:translateX(-4px)}30%,70%{transform:translateX(4px)}}';
document.head.appendChild(style);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
initParticles();
initComunas();
renderMap();
</script>
</body>
</html>